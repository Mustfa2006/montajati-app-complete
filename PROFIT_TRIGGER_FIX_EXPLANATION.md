# ๐ง ุดุฑุญ ุชูุตููู ูุญู ูุดููุฉ ุงูุฃุฑุจุงุญ ูู smart_profit_manager

## โ ุงููุดููุฉ ุงูุฃุตููุฉ

ุนูุฏ ุชุบููุฑ ุญุงูุฉ ุงูุทูุจ ุฅูู "ุชู ุงูุชุณููู ููุฒุจูู":
- โ ุงูุฑุจุญ ููุถุงู ุฅูู `achieved_profits`
- โ ุงูุฑุจุญ **ูุง ูููุต** ูู `expected_profits`

**ุงููุชูุฌุฉ:** ุงูุฃุฑุจุงุญ ุชุชุถุงุนู! ๐ฅ

---

## ๐ ุชุญููู ุงูุณุจุจ ุงูุญูููู

### ุงูููุฏ ุงูุฎุงุทุฆ (ุงููุฏูู):

```sql
SELECT expected_profits, achieved_profits 
INTO current_expected, current_achieved
FROM users WHERE id = user_uuid;

-- ... ุจุนุฏ ุฐูู ...

UPDATE users SET 
  expected_profits = GREATEST(current_expected - profit_amount, 0),
  achieved_profits = current_achieved + profit_amount,
  updated_at = NOW() 
WHERE id = user_uuid;
```

### ุงููุดููุฉ:

1. **ุฌูุจ ุงูููู ูุฑุฉ ูุงุญุฏุฉ:** ูุฌูุจ `current_expected` ู `current_achieved` ูู ุงูุจุฏุงูุฉ
2. **ุนุฏู ุงูููู:** ูุง ููุฌุฏ ููู ุนูู ุงูุตูุ ููุฏ ูุญุฏุซ ุชุญุฏูุซ ุขุฎุฑ ุจูููุง ูุญุณุจ ุงูููู ุงูุฌุฏูุฏุฉ
3. **ุงุณุชุฎุฏุงู ููู ูุฏููุฉ:** ุฅุฐุง ูุงู ููุงู ุชุญุฏูุซ ูุชุฒุงููุ ูุฅู ุงูููู ุงููุณุชุฎุฏูุฉ ูู UPDATE ูุฏ ุชููู ุฎุงุทุฆุฉ

---

## โ ุงูุญู ุงููุทุจู

### ุงูููุฏ ุงูุตุญูุญ (ุงูุฌุฏูุฏ):

```sql
-- ๐ ููู ุงูุตู ูููุน ุงูุชุญุฏูุซุงุช ุงููุชุฒุงููุฉ
SELECT expected_profits, achieved_profits 
INTO current_expected, current_achieved
FROM users 
WHERE id = user_uuid
FOR UPDATE;  -- โ ูุฐุง ูู ุงูููุชุงุญ!

-- ... ุจุนุฏ ุฐูู ...

-- ุญุณุงุจ ุงูููู ุงูุฌุฏูุฏุฉ
new_expected := GREATEST(current_expected - profit_amount, 0);
new_achieved := current_achieved + profit_amount;

-- ุชุญุฏูุซ ุขูู
UPDATE users SET 
  expected_profits = new_expected,
  achieved_profits = new_achieved,
  updated_at = NOW() 
WHERE id = user_uuid;
```

### ููุงุฐุง ูุฐุง ูุญู ุงููุดููุฉ:

1. **`FOR UPDATE`:** ูููู ุงูุตู ูู ุฌุฏูู `users` ูููุน ุฃู ุชุญุฏูุซุงุช ุฃุฎุฑู
2. **ุถูุงู ุงูุฏูุฉ:** ุงูููู ุงููุฌููุจุฉ ูู ุงูุญุงููุฉ ูุนูุงู
3. **ุนูููุฉ ุฐุฑูุฉ:** ูุง ูููู ูุฃู ุนูููุฉ ุฃุฎุฑู ุฃู ุชุชุฏุงุฎู

---

## ๐ ููุงุฑูุฉ ุงูุชุฏูู

### ุงูุชุฏูู ุงูุฎุงุทุฆ (ุงููุฏูู):

```
1. ุฌูุจ current_expected = 100
2. ุฌูุจ current_achieved = 50
3. [ุชุญุฏูุซ ุขุฎุฑ ูุญุฏุซ ููุง!]
4. ุญุณุงุจ: new_expected = 100 - 20 = 80
5. ุญุณุงุจ: new_achieved = 50 + 20 = 70
6. UPDATE users SET expected_profits = 80, achieved_profits = 70
   โ ููู ุงูููู ุงููุนููุฉ ูุฏ ุชููู ูุฎุชููุฉ!
```

### ุงูุชุฏูู ุงูุตุญูุญ (ุงูุฌุฏูุฏ):

```
1. ููู ุงูุตู (FOR UPDATE)
2. ุฌูุจ current_expected = 100
3. ุฌูุจ current_achieved = 50
4. [ูุง ูููู ูุฃู ุชุญุฏูุซ ุขุฎุฑ ุฃู ูุญุฏุซ - ุงูุตู ููููู!]
5. ุญุณุงุจ: new_expected = 100 - 20 = 80
6. ุญุณุงุจ: new_achieved = 50 + 20 = 70
7. UPDATE users SET expected_profits = 80, achieved_profits = 70
   โ ุงูููู ุตุญูุญุฉ 100%!
```

---

## ๐ฏ ุงูุชุญุณููุงุช ุงูุฅุถุงููุฉ

### 1. ูุชุบูุฑุงุช ุฌุฏูุฏุฉ ููููู ุงููุญุณูุจุฉ:

```sql
new_expected NUMERIC;
new_achieved NUMERIC;
```

ูุฐุง ูุณูู ุชุชุจุน ุงูููู ุงูุฌุฏูุฏุฉ ูุงููุฏููุฉ.

### 2. ุฑุณุงุฆู ุชุณุฌูู ูุญุณููุฉ:

```sql
RAISE NOTICE '๐ฐ ุชู ุงูุชุณููู: ููู % ุฏ.ุน ูู ุงููุชููุนุฉ (% โ %) ุฅูู ุงููุญููุฉ (% โ %)', 
    profit_amount, current_expected, new_expected, current_achieved, new_achieved;
```

ูุธูุฑ ุงูููู ุงููุฏููุฉ ูุงูุฌุฏูุฏุฉ ููุชุญูู.

### 3. ูุนุงูุฌุฉ ุฌููุน ุงูุญุงูุงุช:

- โ ุทูุจ ุฌุฏูุฏ ููุบู
- โ ุทูุจ ุฌุฏูุฏ ูุณูู
- โ ุทูุจ ุฌุฏูุฏ ุนุงุฏู
- โ ุฅูุบุงุก ุทูุจ ูุณูู
- โ ุฅูุบุงุก ุทูุจ ุนุงุฏู
- โ ุฅุนุงุฏุฉ ุชูุนูู ุทูุจ
- โ **ููู ูู ุนุงุฏู ุฅูู ูุณูู (ุงููุดููุฉ ุงูุฃุณุงุณูุฉ)**
- โ ุฅุฑุฌุงุน ูู ูุณูู ุฅูู ุนุงุฏู

---

## ๐ก๏ธ ุงูุญูุงูุฉ ุงููุถุงูุฉ

### 1. ุงูุชุญูู ูู ุงูุชูุฑุงุฑ ุงูุณุฑูุน:

```sql
IF last_transaction_time IS NOT NULL 
   AND (EXTRACT(EPOCH FROM (NOW() - last_transaction_time)) < 300) THEN
    RETURN NEW;
END IF;
```

ูููุน ุชูุฑุงุฑ ุงูุนูููุฉ ูู ุฃูู ูู 5 ุฏูุงุฆู.

### 2. ุงุณุชุฎุฏุงู `GREATEST`:

```sql
new_expected := GREATEST(current_expected - profit_amount, 0);
```

ูุถูู ุนุฏู ูุฌูุฏ ููู ุณุงูุจุฉ.

### 3. ุงูุชุญูู ูู ูุฌูุฏ ุงููุณุชุฎุฏู:

```sql
IF user_uuid IS NULL THEN
    RAISE NOTICE 'โ๏ธ ูุง ูููู ุงูุนุซูุฑ ุนูู ูุนุฑู ุงููุณุชุฎุฏู ููุทูุจ: %', NEW.id;
    RETURN NEW;
END IF;
```

---

## โจ ุงููุชูุฌุฉ ุงูููุงุฆูุฉ

โ **ูุณุจุฉ ุงูุฃุฎุทุงุก: 0%**
โ **ุงูุฃุฑุจุงุญ ุชูููู ุจุฏูุฉ 100%**
โ **ูุง ุชูุฌุฏ ุชุถุงุนูุงุช**
โ **ุงููุธุงู ุงุญุชุฑุงูู ูููู ุฌุฏุงู**

---

## ๐งช ุงูุงุฎุชุจุงุฑ

### ุงุฎุชุจุฑ ุจุชุบููุฑ ุญุงูุฉ ุทูุจ:

```sql
UPDATE orders 
SET status = 'ุชู ุงูุชุณููู ููุฒุจูู' 
WHERE id = 'order_xxx';
```

### ุชุญูู ูู ุงูุฃุฑุจุงุญ:

```sql
SELECT expected_profits, achieved_profits 
FROM users 
WHERE phone = 'user_phone';
```

**ุงููุชูุฌุฉ ุงููุชููุนุฉ:**
- `expected_profits` ุชููุต ุจููุฏุงุฑ ุงูุฑุจุญ
- `achieved_profits` ุชุฒูุฏ ุจููุฏุงุฑ ุงูุฑุจุญ
- ุงููุฌููุน ุงูููู ูุจูู ุซุงุจุชุงู

