// ===================================
// Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø®Ø§Ø¯Ù… Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠ Ø¹Ù„Ù‰ Render
// Test Real Server on Render
// ===================================

const https = require('https');

async function testRenderServer() {
  console.log('ğŸŒ Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø®Ø§Ø¯Ù… Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠ Ø¹Ù„Ù‰ Render.com...');
  console.log('ğŸ”— URL: https://montajati-backend.onrender.com');
  console.log('='.repeat(60));

  const baseURL = 'https://montajati-backend.onrender.com';

  try {
    // Ø§Ù„Ù…Ø±Ø­Ù„Ø© 1: Ø§Ø®ØªØ¨Ø§Ø± Ø­Ø§Ù„Ø© Ø§Ù„Ø®Ø§Ø¯Ù…
    console.log('\nğŸ“¡ Ø§Ù„Ù…Ø±Ø­Ù„Ø© 1: Ø§Ø®ØªØ¨Ø§Ø± Ø­Ø§Ù„Ø© Ø§Ù„Ø®Ø§Ø¯Ù…');
    console.log('='.repeat(40));
    
    const healthResult = await makeRequest('GET', `${baseURL}/health`);
    
    if (healthResult.success) {
      console.log('âœ… Ø§Ù„Ø®Ø§Ø¯Ù… ÙŠØ¹Ù…Ù„ Ø¨Ø´ÙƒÙ„ ØµØ­ÙŠØ­');
      console.log('ğŸ“‹ Ø§Ø³ØªØ¬Ø§Ø¨Ø© Ø§Ù„Ø®Ø§Ø¯Ù…:', JSON.stringify(healthResult.data, null, 2));
    } else {
      console.log('âŒ Ø§Ù„Ø®Ø§Ø¯Ù… Ù„Ø§ ÙŠØ³ØªØ¬ÙŠØ¨');
      console.log('ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø®Ø·Ø£:', healthResult);
      return false;
    }

    // Ø§Ù„Ù…Ø±Ø­Ù„Ø© 2: Ø¬Ù„Ø¨ Ø·Ù„Ø¨ Ù„Ù„Ø§Ø®ØªØ¨Ø§Ø±
    console.log('\nğŸ“¦ Ø§Ù„Ù…Ø±Ø­Ù„Ø© 2: Ø¬Ù„Ø¨ Ø·Ù„Ø¨ Ù„Ù„Ø§Ø®ØªØ¨Ø§Ø±');
    console.log('='.repeat(40));
    
    const ordersResult = await makeRequest('GET', `${baseURL}/api/orders?limit=1`);
    
    if (!ordersResult.success) {
      console.log('âŒ ÙØ´Ù„ ÙÙŠ Ø¬Ù„Ø¨ Ø§Ù„Ø·Ù„Ø¨Ø§Øª');
      console.log('ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø®Ø·Ø£:', ordersResult);
      return false;
    }

    if (!ordersResult.data?.data?.length) {
      console.log('âš ï¸ Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª Ù„Ù„Ø§Ø®ØªØ¨Ø§Ø±');
      return false;
    }

    const testOrder = ordersResult.data.data[0];
    console.log(`ğŸ“‹ Ø·Ù„Ø¨ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±: ${testOrder.id}`);
    console.log(`ğŸ“Š Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©: ${testOrder.status}`);
    console.log(`ğŸšš Ù…Ø¹Ø±Ù Ø§Ù„ÙˆØ³ÙŠØ·: ${testOrder.waseet_order_id || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}`);

    // Ø§Ù„Ù…Ø±Ø­Ù„Ø© 3: Ø§Ø®ØªØ¨Ø§Ø± ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ø§Ù„Ø©
    console.log('\nğŸ”„ Ø§Ù„Ù…Ø±Ø­Ù„Ø© 3: Ø§Ø®ØªØ¨Ø§Ø± ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ø§Ù„Ø©');
    console.log('='.repeat(40));
    
    const updateData = {
      status: 'Ù‚ÙŠØ¯ Ø§Ù„ØªÙˆØµÙŠÙ„ Ø§Ù„Ù‰ Ø§Ù„Ø²Ø¨ÙˆÙ† (ÙÙŠ Ø¹Ù‡Ø¯Ø© Ø§Ù„Ù…Ù†Ø¯ÙˆØ¨)',
      notes: 'Ø§Ø®ØªØ¨Ø§Ø± ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ø§Ù„Ø© Ù…Ù† Ø§Ù„Ø®Ø§Ø¯Ù… Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠ',
      changedBy: 'production_test'
    };

    console.log(`ğŸ”„ ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ø·Ù„Ø¨ ${testOrder.id}...`);
    console.log('ğŸ“‹ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØªØ­Ø¯ÙŠØ«:', JSON.stringify(updateData, null, 2));

    const updateResult = await makeRequest('PUT', `${baseURL}/api/orders/${testOrder.id}/status`, updateData);
    
    if (updateResult.success) {
      console.log('âœ… ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ø§Ù„Ø© Ø¨Ù†Ø¬Ø§Ø­');
      console.log('ğŸ“‹ Ø§Ø³ØªØ¬Ø§Ø¨Ø© Ø§Ù„Ø®Ø§Ø¯Ù…:', JSON.stringify(updateResult.data, null, 2));
      
      // Ø§Ù†ØªØ¸Ø§Ø± Ù‚Ù„ÙŠÙ„ Ø«Ù… ÙØ­Øµ Ø§Ù„Ø·Ù„Ø¨
      console.log('\nâ±ï¸ Ø§Ù†ØªØ¸Ø§Ø± 15 Ø«Ø§Ù†ÙŠØ© Ø«Ù… ÙØ­Øµ Ø§Ù„Ø·Ù„Ø¨...');
      await new Promise(resolve => setTimeout(resolve, 15000));
      
      const checkResult = await makeRequest('GET', `${baseURL}/api/orders/${testOrder.id}`);
      
      if (checkResult.success) {
        const updatedOrder = checkResult.data?.data || checkResult.data;
        
        console.log('\nğŸ“‹ Ø­Ø§Ù„Ø© Ø§Ù„Ø·Ù„Ø¨ Ø¨Ø¹Ø¯ Ø§Ù„ØªØ­Ø¯ÙŠØ«:');
        console.log(`   ğŸ“Š Ø§Ù„Ø­Ø§Ù„Ø©: ${updatedOrder.status}`);
        console.log(`   ğŸšš Ù…Ø¹Ø±Ù Ø§Ù„ÙˆØ³ÙŠØ·: ${updatedOrder.waseet_order_id || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}`);
        console.log(`   ğŸ“‹ Ø­Ø§Ù„Ø© Ø§Ù„ÙˆØ³ÙŠØ·: ${updatedOrder.waseet_status || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}`);
        console.log(`   ğŸ• Ø¢Ø®Ø± ØªØ­Ø¯ÙŠØ«: ${updatedOrder.updated_at}`);
        
        if (updatedOrder.waseet_data) {
          try {
            const waseetData = JSON.parse(updatedOrder.waseet_data);
            console.log(`   ğŸ“‹ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ÙˆØ³ÙŠØ·:`, waseetData);
          } catch (e) {
            console.log(`   ğŸ“‹ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ÙˆØ³ÙŠØ· (Ø®Ø§Ù…): ${updatedOrder.waseet_data}`);
          }
        }
        
        // ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ù†ØªÙŠØ¬Ø©
        if (updatedOrder.waseet_order_id) {
          console.log('\nğŸ‰ Ù†Ø¬Ø­! ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨ Ù„Ù„ÙˆØ³ÙŠØ·');
          return true;
        } else if (updatedOrder.waseet_status === 'ÙÙŠ Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ Ù„Ù„ÙˆØ³ÙŠØ·') {
          console.log('\nâš ï¸ Ø§Ù„Ù†Ø¸Ø§Ù… Ø­Ø§ÙˆÙ„ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ Ù„ÙƒÙ† ÙØ´Ù„ - Ø³ÙŠØ¹ÙŠØ¯ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù„Ø§Ø­Ù‚Ø§Ù‹');
          return 'retry_needed';
        } else {
          console.log('\nâŒ Ø§Ù„Ù†Ø¸Ø§Ù… Ù„Ù… ÙŠØ­Ø§ÙˆÙ„ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨ Ù„Ù„ÙˆØ³ÙŠØ·');
          return false;
        }
      } else {
        console.log('âŒ ÙØ´Ù„ ÙÙŠ Ø¬Ù„Ø¨ Ø§Ù„Ø·Ù„Ø¨ Ø§Ù„Ù…Ø­Ø¯Ø«');
        return false;
      }
    } else {
      console.log('âŒ ÙØ´Ù„ ÙÙŠ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ø§Ù„Ø©');
      console.log('ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø®Ø·Ø£:', updateResult);
      return false;
    }

  } catch (error) {
    console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±:', error);
    return false;
  }
}

// Ø¯Ø§Ù„Ø© Ù…Ø³Ø§Ø¹Ø¯Ø© Ù„Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨Ø§Øª
async function makeRequest(method, url, data = null) {
  return new Promise((resolve) => {
    const urlObj = new URL(url);
    
    const options = {
      hostname: urlObj.hostname,
      port: 443,
      path: urlObj.pathname + urlObj.search,
      method: method,
      headers: {
        'Content-Type': 'application/json',
        'User-Agent': 'Production-Test/1.0'
      },
      timeout: 30000
    };

    if (data && (method === 'POST' || method === 'PUT')) {
      const jsonData = JSON.stringify(data);
      options.headers['Content-Length'] = Buffer.byteLength(jsonData);
    }

    const req = https.request(options, (res) => {
      let responseData = '';

      res.on('data', (chunk) => {
        responseData += chunk;
      });

      res.on('end', () => {
        try {
          const parsedData = responseData ? JSON.parse(responseData) : {};
          
          if (res.statusCode >= 200 && res.statusCode < 300) {
            resolve({
              success: true,
              status: res.statusCode,
              data: parsedData
            });
          } else {
            resolve({
              success: false,
              status: res.statusCode,
              error: parsedData,
              rawResponse: responseData
            });
          }
        } catch (parseError) {
          resolve({
            success: false,
            status: res.statusCode,
            error: 'ÙØ´Ù„ ÙÙŠ ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø§Ø³ØªØ¬Ø§Ø¨Ø©',
            rawResponse: responseData
          });
        }
      });
    });

    req.on('error', (error) => {
      resolve({
        success: false,
        error: error.message
      });
    });

    req.on('timeout', () => {
      req.destroy();
      resolve({
        success: false,
        error: 'Ø§Ù†ØªÙ‡Øª Ù…Ù‡Ù„Ø© Ø§Ù„Ø§ØªØµØ§Ù„'
      });
    });

    if (data && (method === 'POST' || method === 'PUT')) {
      req.write(JSON.stringify(data));
    }

    req.end();
  });
}

// ØªØ´ØºÙŠÙ„ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±
testRenderServer()
  .then((result) => {
    console.log('\nğŸ¯ Ø§Ù„Ù†ØªÙŠØ¬Ø© Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ©:');
    console.log('='.repeat(60));
    if (result === true) {
      console.log('ğŸ‰ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± Ù†Ø¬Ø­! Ø§Ù„Ø®Ø§Ø¯Ù… Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠ ÙŠØ±Ø³Ù„ Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ù„Ù„ÙˆØ³ÙŠØ·');
      console.log('âœ… Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ù…ÙØµØ¯ÙÙ‘Ø± Ø³ÙŠØ¹Ù…Ù„ Ø¨Ø´ÙƒÙ„ ØµØ­ÙŠØ­');
    } else if (result === 'retry_needed') {
      console.log('âš ï¸ Ø§Ù„Ø®Ø§Ø¯Ù… ÙŠØ­Ø§ÙˆÙ„ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ Ù„ÙƒÙ† ÙŠØ­ØªØ§Ø¬ Ø¥Ø¹Ø§Ø¯Ø© Ù…Ø­Ø§ÙˆÙ„Ø©');
      console.log('ğŸ”„ Ø§Ù„Ù†Ø¸Ø§Ù… Ø³ÙŠØ¹ÙŠØ¯ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹');
    } else {
      console.log('âŒ Ø§Ù„Ø®Ø§Ø¯Ù… Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠ Ù„Ø§ ÙŠØ±Ø³Ù„ Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ù„Ù„ÙˆØ³ÙŠØ·');
      console.log('ğŸ”§ ÙŠØ­ØªØ§Ø¬ Ø¥ØµÙ„Ø§Ø­ Ù‚Ø¨Ù„ Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„ØªØ·Ø¨ÙŠÙ‚');
    }
  })
  .catch((error) => {
    console.error('âŒ Ø®Ø·Ø£ ÙÙŠ ØªØ´ØºÙŠÙ„ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±:', error);
  });
