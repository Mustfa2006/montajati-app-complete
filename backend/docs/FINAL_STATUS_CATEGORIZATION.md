# ๐ ุงูุชุตููู ุงูููุงุฆู ูุญุงูุงุช ุงูุทูุจุงุช
## Final Order Status Categorization

---

## ๐ฏ **ุงูุชุตููู ุงูุตุญูุญ ุญุณุจ ูุชุทูุจุงุช ุงููุณุชุฎุฏู:**

### **1๏ธโฃ ูุณู ุงููุดุท (Active):**
```javascript
['active', 'ูุนุงู', 'ูุดุท']
```
**ุนุฏุฏ ุงูุญุงูุงุช:** 3

---

### **2๏ธโฃ ูุณู ููุฏ ุงูุชูุตูู (In Delivery):**
```javascript
[
  'ููุฏ ุงูุชูุตูู ุงูู ุงูุฒุจูู (ูู ุนูุฏุฉ ุงูููุฏูุจ)',
  'ุชู ุงูุงุณุชูุงู ูู ูุจู ุงูููุฏูุจ'
]
```
**ุนุฏุฏ ุงูุญุงูุงุช:** 2

**ููุงุญุธุฉ ูููุฉ:** ุนูุฏูุง ูุฃุชู ุทูุจ ูู Waseet ุจุญุงูุฉ "ุชู ุงูุงุณุชูุงู ูู ูุจู ุงูููุฏูุจ"ุ ูุชู ุชุญูููู ุฅูู:
- `status` = "ููุฏ ุงูุชูุตูู ุงูู ุงูุฒุจูู (ูู ุนูุฏุฉ ุงูููุฏูุจ)"
- `waseet_status_text` = "ุชู ุงูุงุณุชูุงู ูู ูุจู ุงูููุฏูุจ"

ูุฐูู ูุฌุจ ุงูุจุญุซ ูู ููุง ุงูุนููุฏูู (`status` ู `waseet_status_text`) ูุถูุงู ุฌูุจ ุฌููุน ุงูุทูุจุงุช.

**ุชู ุฅุฒุงูุฉ 'in_delivery':** ูุง ุชูุฌุฏ ุทูุจุงุช ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช ุจุญุงูุฉ 'in_delivery' - ุฌููุน ุงูุทูุจุงุช ุชุณุชุฎุฏู ุงููุต ุงูุนุฑุจู ุงููุงูู.

---

### **3๏ธโฃ ูุณู ุชู ุงูุชุณููู (Delivered):**
```javascript
['ุชู ุงูุชุณููู ููุฒุจูู', 'delivered']
```
**ุนุฏุฏ ุงูุญุงูุงุช:** 2

---

### **4๏ธโฃ ูุณู ุงูููุบู (Cancelled):**
```javascript
['ุงูุบุงุก ุงูุทูุจ', 'ุฑูุถ ุงูุทูุจ', 'cancelled']
```
**ุนุฏุฏ ุงูุญุงูุงุช:** 3

**ููุงุญุธุฉ ูููุฉ:** ููุท ูุงุชูู ุงูุญุงูุชูู ุชุธูุฑุงู ูู ูุณู ุงูููุบู:
- ุงูุบุงุก ุงูุทูุจ
- ุฑูุถ ุงูุทูุจ

ุฌููุน ุงูุญุงูุงุช ุงูุฃุฎุฑู ุงูุชู ูุงูุช ุชูุนุชุจุฑ "ููุบุงุฉ" ูู Waseet (ูุซู: ููุตูู ุนู ุงูุฎุฏูุฉุ ุทูุจ ููุฑุฑุ ุญุธุฑ ุงูููุฏูุจุ ุฅูุฎ) ุชุธูุฑ ุงูุขู ูู ูุณู **ุงููุนุงูุฌุงุช**.

---

### **5๏ธโฃ ูุณู ุงููุนุงูุฌุงุช (Processing):**
```javascript
[
  'ุชู ุชุบููุฑ ูุญุงูุธุฉ ุงูุฒุจูู',
  'ุชุบููุฑ ุงูููุฏูุจ',
  'ูุง ูุฑุฏ',
  'ูุง ูุฑุฏ ุจุนุฏ ุงูุงุชูุงู',
  'ูุบูู',
  'ูุบูู ุจุนุฏ ุงูุงุชูุงู',
  'ุงูุฑูู ุบูุฑ ูุนุฑู',
  'ุงูุฑูู ุบูุฑ ุฏุงุฎู ูู ุงูุฎุฏูุฉ',
  'ูุง ูููู ุงูุงุชุตุงู ุจุงูุฑูู',
  'ูุคุฌู',
  'ูุคุฌู ูุญูู ุงุนุงุฏุฉ ุงูุทูุจ ูุงุญูุง',
  'ููุตูู ุนู ุงูุฎุฏูุฉ',
  'ุทูุจ ููุฑุฑ',
  'ูุณุชูู ูุณุจูุง',
  'ุงูุนููุงู ุบูุฑ ุฏููู',
  'ูู ูุทูุจ',
  'ุญุธุฑ ุงูููุฏูุจ'
]
```
**ุนุฏุฏ ุงูุญุงูุงุช:** 17

**ุงูุชุนุฑูู:** ูุณู ุงููุนุงูุฌุงุช ูุนุฑุถ **ุฌููุน ุงูุญุงูุงุช** ูุง ุนุฏุง:
- โ ุงููุดุท / active / ูุนุงู
- โ ููุฏ ุงูุชูุตูู ุงูู ุงูุฒุจูู (ูู ุนูุฏุฉ ุงูููุฏูุจ)
- โ ุชู ุงูุชุณููู ููุฒุจูู
- โ ุงูุบุงุก ุงูุทูุจ
- โ ุฑูุถ ุงูุทูุจ
- โ ูุฌุฏูู

---

## ๐ **ุฌุฏูู ููุงุฑูุฉ ุงูุชุตููู:**

| ุงูุญุงูุฉ | ุงูุชุตููู ูู Waseet | ุงูุชุตููู ูู ุงูุชุทุจูู |
|--------|-------------------|---------------------|
| ูุดุท | active | ูุดุท |
| ููุฏ ุงูุชูุตูู ุงูู ุงูุฒุจูู (ูู ุนูุฏุฉ ุงูููุฏูุจ) | in_delivery | ููุฏ ุงูุชูุตูู |
| ุชู ุงูุชุณููู ููุฒุจูู | delivered | ุชู ุงูุชุณููู |
| ุงูุบุงุก ุงูุทูุจ | cancelled | ููุบู |
| ุฑูุถ ุงูุทูุจ | cancelled | ููุบู |
| ููุตูู ุนู ุงูุฎุฏูุฉ | cancelled | **ูุนุงูุฌุฉ** โ๏ธ |
| ุทูุจ ููุฑุฑ | cancelled | **ูุนุงูุฌุฉ** โ๏ธ |
| ูุณุชูู ูุณุจูุง | cancelled | **ูุนุงูุฌุฉ** โ๏ธ |
| ูู ูุทูุจ | cancelled | **ูุนุงูุฌุฉ** โ๏ธ |
| ุญุธุฑ ุงูููุฏูุจ | cancelled | **ูุนุงูุฌุฉ** โ๏ธ |
| ูุง ูุฑุฏ | contact_issue | ูุนุงูุฌุฉ |
| ูุง ูุฑุฏ ุจุนุฏ ุงูุงุชูุงู | contact_issue | ูุนุงูุฌุฉ |
| ูุบูู | contact_issue | ูุนุงูุฌุฉ |
| ูุบูู ุจุนุฏ ุงูุงุชูุงู | contact_issue | ูุนุงูุฌุฉ |
| ุงูุฑูู ุบูุฑ ูุนุฑู | contact_issue | ูุนุงูุฌุฉ |
| ุงูุฑูู ุบูุฑ ุฏุงุฎู ูู ุงูุฎุฏูุฉ | contact_issue | ูุนุงูุฌุฉ |
| ูุง ูููู ุงูุงุชุตุงู ุจุงูุฑูู | contact_issue | ูุนุงูุฌุฉ |
| ุงูุนููุงู ุบูุฑ ุฏููู | address_issue | ูุนุงูุฌุฉ |
| ุชู ุชุบููุฑ ูุญุงูุธุฉ ุงูุฒุจูู | modified | ูุนุงูุฌุฉ |
| ุชุบููุฑ ุงูููุฏูุจ | modified | ูุนุงูุฌุฉ |
| ูุคุฌู | postponed | ูุนุงูุฌุฉ |
| ูุคุฌู ูุญูู ุงุนุงุฏุฉ ุงูุทูุจ ูุงุญูุง | postponed | ูุนุงูุฌุฉ |

---

## ๐ **ููููุฉ ุนูู ุงูููุชุฑุฉ:**

### **ูู Backend API:**

#### **1. Endpoint ุงูููุชุฑุฉ:**
```
GET /api/orders/user/:userPhone?statusFilter=processing
```

**ุงูููุฏ:**
```javascript
const statusGroups = {
  'processing': [/* 19 ุญุงูุฉ */],
  'active': ['active', 'ูุนุงู', 'ูุดุท'],
  'in_delivery': ['ููุฏ ุงูุชูุตูู ุงูู ุงูุฒุจูู (ูู ุนูุฏุฉ ุงูููุฏูุจ)', 'in_delivery'],
  'delivered': ['ุชู ุงูุชุณููู ููุฒุจูู', 'delivered'],
  'cancelled': ['ุงูุบุงุก ุงูุทูุจ', 'ุฑูุถ ุงูุทูุจ', 'cancelled']
};

// ุงูุจุญุซ ูู ููุง ุงูุนููุฏูู: status ู waseet_status_text
const statusConditions = statuses.map(s => `status.eq.${s}`).join(',');
const waseetConditions = statuses.map(s => `waseet_status_text.eq.${s}`).join(',');
query = query.or(`${statusConditions},${waseetConditions}`);
```

#### **2. Endpoint ุงูุนุฏุงุฏุงุช:**
```
GET /api/orders/user/:userPhone/counts
```

**ุงูููุฏ:**
```javascript
const { data: allOrders } = await supabase
  .from('orders')
  .select('status, waseet_status_text')  // โ ุฌูุจ ููุง ุงูุนููุฏูู
  .eq('user_phone', userPhone);

const counts = {
  processing: allOrders.filter(o =>
    processingStatuses.includes(o.status) || processingStatuses.includes(o.waseet_status_text)
  ).length,
  active: allOrders.filter(o =>
    activeStatuses.includes(o.status) || activeStatuses.includes(o.waseet_status_text)
  ).length,
  // ... ุฅูุฎ
};
```

---

## โ **ุงููุชูุฌุฉ:**

### **ูุจู ุงูุฅุตูุงุญ:**
- โ ูุณู ุงููุนุงูุฌุงุช: ุงูุนุฏุงุฏ 5ุ ุงููุนุฑูุถ 2
- โ ูุณู ููุฏ ุงูุชูุตูู: ุงูุนุฏุงุฏ 8ุ ุงููุนุฑูุถ 0
- โ ูุณู ุงูููุบู: ูุนุฑุถ 10 ุญุงูุงุช ุจุฏูุงู ูู 2

### **ุจุนุฏ ุงูุฅุตูุงุญ:**
- โ ูุณู ุงููุนุงูุฌุงุช: ุงูุนุฏุงุฏ = ุงููุนุฑูุถ (17 ุญุงูุฉ)
- โ ูุณู ููุฏ ุงูุชูุตูู: ุงูุนุฏุงุฏ = ุงููุนุฑูุถ (3 ุญุงูุงุช - ุชู ุฅุถุงูุฉ "ุชู ุงูุงุณุชูุงู ูู ูุจู ุงูููุฏูุจ")
- โ ูุณู ุงูููุบู: ูุนุฑุถ ููุท "ุงูุบุงุก ุงูุทูุจ" ู "ุฑูุถ ุงูุทูุจ"
- โ ูุณู ุงููุดุท: ูุนุฑุถ ููุท "ูุดุท" ู "active" ู "ูุนุงู"
- โ ูุณู ุชู ุงูุชุณููู: ูุนุฑุถ ููุท "ุชู ุงูุชุณููู ููุฒุจูู"
- โ ูุธุงู ุฐูู ูููุน Race Condition ุนูุฏ ุงูุชุจุฏูู ุงูุณุฑูุน
- โ Retry Mechanism ุชููุงุฆู ุนูุฏ ูุดู ุงูุงุชุตุงู (5 ูุญุงููุงุช ูุน Exponential Backoff)
- โ Debouncing ููุชุจุฏูู ุจูู ุงูุญุงูุงุช (50ms - ุชูุงุนู ุณุฑูุน ุฌุฏุงู)
- โ Timeout ุฃุทูู (30 ุซุงููุฉ ุจุฏูุงู ูู 15 ุซุงููุฉ)

---

## ๐ **ุงููููุงุช ุงููุนุฏูุฉ:**

### **1. backend/routes/orders.js**

**ุงูุณุทูุฑ 283-315:** ุชุญุฏูุซ `statusGroups` ูู endpoint ุงูููุชุฑุฉ
```javascript
'processing': [/* 19 ุญุงูุฉ */],
'active': ['active', 'ูุนุงู', 'ูุดุท'],
'in_delivery': ['ููุฏ ุงูุชูุตูู ุงูู ุงูุฒุจูู (ูู ุนูุฏุฉ ุงูููุฏูุจ)', 'in_delivery'],
'delivered': ['ุชู ุงูุชุณููู ููุฒุจูู', 'delivered'],
'cancelled': ['ุงูุบุงุก ุงูุทูุจ', 'ุฑูุถ ุงูุทูุจ', 'cancelled']
```

**ุงูุณุทูุฑ 394-426:** ุชุญุฏูุซ ุงูุญุงูุงุช ูู endpoint ุงูุนุฏุงุฏุงุช
```javascript
const processingStatuses = [/* 19 ุญุงูุฉ */];
const activeStatuses = ['active', 'ูุนุงู', 'ูุดุท'];
const inDeliveryStatuses = ['ููุฏ ุงูุชูุตูู ุงูู ุงูุฒุจูู (ูู ุนูุฏุฉ ุงูููุฏูุจ)', 'in_delivery'];
const deliveredStatuses = ['ุชู ุงูุชุณููู ููุฒุจูู', 'delivered'];
const cancelledStatuses = ['ุงูุบุงุก ุงูุทูุจ', 'ุฑูุถ ุงูุทูุจ', 'cancelled'];
```

**ุงูุณุทูุฑ 428-446:** ุชุญุฏูุซ ุญุณุงุจ ุงูุนุฏุงุฏุงุช
```javascript
active: allOrders.filter(o =>
  activeStatuses.includes(o.status) || activeStatuses.includes(o.waseet_status_text)
).length,
```

---

## ๐งช **ุงูุงุฎุชุจุงุฑ:**

### **1. ุงุฎุชุจุงุฑ ูุณู ุงููุนุงูุฌุงุช:**
```bash
# ุฌูุจ ุงูุนุฏุงุฏุงุช
GET /api/orders/user/07700000000/counts
# ุงููุชูุฌุฉ ุงููุชููุนุฉ: { processing: X }

# ุฌูุจ ุงูุทูุจุงุช ุงููููุชุฑุฉ
GET /api/orders/user/07700000000?statusFilter=processing
# ุงููุชูุฌุฉ ุงููุชููุนุฉ: X ุทูุจุงุช (ููุณ ุงูุนุฏุฏ)
```

### **2. ุงุฎุชุจุงุฑ ูุณู ุงูููุบู:**
```bash
# ุฌูุจ ุงูุนุฏุงุฏุงุช
GET /api/orders/user/07700000000/counts
# ุงููุชูุฌุฉ ุงููุชููุนุฉ: { cancelled: Y } (ููุท ุงูุบุงุก ุงูุทูุจ + ุฑูุถ ุงูุทูุจ)

# ุฌูุจ ุงูุทูุจุงุช ุงููููุชุฑุฉ
GET /api/orders/user/07700000000?statusFilter=cancelled
# ุงููุชูุฌุฉ ุงููุชููุนุฉ: Y ุทูุจุงุช (ููุท ุงูุบุงุก ุงูุทูุจ + ุฑูุถ ุงูุทูุจ)
```

---

## ๐ **ุงููุธุงู ุงูุฐูู ูููุน Race Condition:**

### **ุงููุดููุฉ:**
ุนูุฏ ุงูุชุจุฏูู ุงูุณุฑูุน ุจูู ุงูุญุงูุงุช (ูุซูุงู: ูุดุท โ ููุฏ ุงูุชูุตูู โ ูุนุงูุฌุฉ โ ููุบู)ุ ูุงูุช ุชุญุฏุซ ูุดููุฉ **Race Condition**:
- ูุชู ุฅุฑุณุงู 4 ุทูุจุงุช HTTP ูู ููุณ ุงูููุช
- ุงูุทูุจ ุงูุฃุฎูุฑ ูุฏ ูุตู ูุจู ุงูุทูุจุงุช ุงูุณุงุจูุฉ
- ุงููุชูุฌุฉ: ุชุธูุฑ ุจูุงูุงุช ุฎุงุทุฆุฉ ุฃู ุชุฎุชูู ุงูุทูุจุงุช

### **ุงูุญู:**

#### **1. Request ID System:**
```dart
int _currentRequestId = 0;

Future<void> _loadOrdersFromDatabase() async {
  // ุฅูุดุงุก ูุนุฑู ูุฑูุฏ ููุฐุง ุงูุทูุจ
  final requestId = ++_currentRequestId;

  // ... ุฅุฑุณุงู ุงูุทูุจ ...

  // ูุญุต ุฅุฐุง ุชู ุฅูุบุงุก ูุฐุง ุงูุทูุจ
  if (requestId != _currentRequestId) {
    debugPrint('๐ซ ุชู ุฅูุบุงุก ุงูุทูุจ $requestId');
    return; // ุฅูุบุงุก ุงูุทูุจ ุงููุฏูู
  }

  // ุชุญุฏูุซ ุงูุจูุงูุงุช ููุท ุฅุฐุง ูุงู ูุฐุง ูู ุงูุทูุจ ุงูุฃุญุฏุซ
  setState(() { ... });
}
```

#### **2. Debouncing (50ms - ุชูุงุนู ุณุฑูุน ุฌุฏุงู):**
```dart
Timer? _filterDebounceTimer;

onTap: () {
  // ุฅูุบุงุก ุงููุคูุช ุงูุณุงุจู
  _filterDebounceTimer?.cancel();

  // ุชุญุฏูุซ UI ููุฑุงู
  setState(() { selectedFilter = status; });

  // ุงูุชุธุงุฑ 50ms ููุท ูุจู ุฌูุจ ุงูุจูุงูุงุช (ุชูุงุนู ุณุฑูุน ุฌุฏุงู)
  _filterDebounceTimer = Timer(const Duration(milliseconds: 50), () {
    _loadOrdersFromDatabase();
  });
}
```

#### **3. Retry Mechanism (5 ูุญุงููุงุช ูุน Exponential Backoff):**
```dart
final int _maxRetries = 5;

Future<void> _loadOrdersFromDatabase({int retryAttempt = 0}) async {
  try {
    // ... ุฅุฑุณุงู ุงูุทูุจ ...
  } on TimeoutException {
    if (retryAttempt < _maxRetries && requestId == _currentRequestId) {
      final waitSeconds = 2 * (retryAttempt + 1); // 2s, 4s, 6s, 8s, 10s
      await Future.delayed(Duration(seconds: waitSeconds));
      return _loadOrdersFromDatabase(retryAttempt: retryAttempt + 1);
    }
  }
}
```

**Exponential Backoff:** ุงูุงูุชุธุงุฑ ูุฒุฏุงุฏ ูุน ูู ูุญุงููุฉ:
- ุงููุญุงููุฉ 1: ุงูุชุธุงุฑ 2 ุซุงููุฉ
- ุงููุญุงููุฉ 2: ุงูุชุธุงุฑ 4 ุซูุงูู
- ุงููุญุงููุฉ 3: ุงูุชุธุงุฑ 6 ุซูุงูู
- ุงููุญุงููุฉ 4: ุงูุชุธุงุฑ 8 ุซูุงูู
- ุงููุญุงููุฉ 5: ุงูุชุธุงุฑ 10 ุซูุงูู

#### **4. Timeout ุฃุทูู (30 ุซุงููุฉ):**
```dart
final response = await http
    .get(url)
    .timeout(const Duration(seconds: 30)); // ุจุฏูุงู ูู 15 ุซุงููุฉ
```

### **ุงููุชูุฌุฉ:**
- โ ูุง ุชูุฌุฏ ูุดุงูู ุนูุฏ ุงูุชุจุฏูู ุงูุณุฑูุน ุจูู ุงูุญุงูุงุช (Debouncing 50ms)
- โ ุฅุนุงุฏุฉ ูุญุงููุฉ ุชููุงุฆูุฉ ุนูุฏ ูุดู ุงูุงุชุตุงู (5 ูุฑุงุช ูุน Exponential Backoff)
- โ ุชุฌุฑุจุฉ ูุณุชุฎุฏู ุณูุณุฉ ุญุชู ูุน ุฅูุชุฑูุช ุถุนูู (Timeout 30 ุซุงููุฉ)
- โ ุฅูุบุงุก ุชููุงุฆู ููุทูุจุงุช ุงููุฏููุฉ (Request ID System)
- โ ุชูุงุนู ุณุฑูุน ุฌุฏุงู ุนูุฏ ุงุฎุชูุงุฑ ุงูุญุงูุงุช (50ms ููุท)
- โ ูููุฉ ูุงููุฉ ููุชุญููู ูุจู ุฅุธูุงุฑ ุฎุทุฃ (30 ุซุงููุฉ + 5 ูุญุงููุงุช)

---

**ุชุงุฑูุฎ ุงูุชุญุฏูุซ:** 2025-11-04
**ุงููุทูุฑ:** Augment AI Agent
**ุงูุญุงูุฉ:** โ ููุชูู ููุฎุชุจุฑ

