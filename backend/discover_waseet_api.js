// ===================================
// ุงูุชุดุงู API ุงูุตุญูุญ ูุดุฑูุฉ ุงููุณูุท
// Discover Correct Waseet API
// ===================================

const axios = require('axios');
const { createClient } = require('@supabase/supabase-js');
require('dotenv').config();

async function discoverWaseetAPI() {
  try {
    console.log('๐ ุงูุชุดุงู API ุงูุตุญูุญ ูุดุฑูุฉ ุงููุณูุท...\n');

    // ุฅุนุฏุงุฏ Supabase
    const supabase = createClient(
      process.env.SUPABASE_URL,
      process.env.SUPABASE_SERVICE_ROLE_KEY
    );

    // ุฅุนุฏุงุฏุงุช ุดุฑูุฉ ุงููุณูุท
    const waseetConfig = {
      baseUrl: process.env.ALMASEET_BASE_URL || 'https://api.alwaseet-iq.net',
      username: process.env.WASEET_USERNAME,
      password: process.env.WASEET_PASSWORD
    };

    // 1. ุชุณุฌูู ุงูุฏุฎูู
    console.log('๐ ุชุณุฌูู ุงูุฏุฎูู...');
    const loginData = new URLSearchParams({
      username: waseetConfig.username,
      password: waseetConfig.password
    });

    const loginResponse = await axios.post(
      `${waseetConfig.baseUrl}/merchant/login`,
      loginData,
      {
        timeout: 15000,
        headers: {
          'Content-Type': 'application/x-www-form-urlencoded',
          'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36'
        },
        maxRedirects: 0,
        validateStatus: () => true
      }
    );

    if (loginResponse.status !== 302 && loginResponse.status !== 303) {
      throw new Error(`ูุดู ุชุณุฌูู ุงูุฏุฎูู: ${loginResponse.status}`);
    }

    const token = loginResponse.headers['set-cookie']?.join('; ') || '';
    console.log('โ ุชู ุชุณุฌูู ุงูุฏุฎูู ุจูุฌุงุญ');

    // 2. ุฌูุจ ุทูุจ ุญูููู ููุงุฎุชุจุงุฑ
    console.log('\n๐ ุฌูุจ ุทูุจ ุญูููู ููุงุฎุชุจุงุฑ...');
    const { data: orders } = await supabase
      .from('orders')
      .select('id, order_number, waseet_order_id')
      .not('waseet_order_id', 'is', null)
      .limit(1);

    if (!orders || orders.length === 0) {
      throw new Error('ูุง ุชูุฌุฏ ุทูุจุงุช ููุงุฎุชุจุงุฑ');
    }

    const testOrder = orders[0];
    console.log(`โ ุทูุจ ุงูุงุฎุชุจุงุฑ: ${testOrder.order_number} (ID: ${testOrder.waseet_order_id})`);

    // 3. ุงุฎุชุจุงุฑ endpoints ูุฎุชููุฉ ุจุทุฑู ูุชููุนุฉ
    const testEndpoints = [
      // ุงูุทุฑู ุงูุฃุณุงุณูุฉ
      '/merchant',
      '/merchant/',
      '/merchant/home',
      '/merchant/dashboard',
      '/merchant/index',
      
      // ุทุฑู ุฌูุจ ุงูุทูุจุงุช
      '/merchant-orders',
      '/merchant/order-list',
      '/merchant/my-orders',
      '/merchant/orders-list',
      '/merchant/all-orders',
      
      // ุทุฑู ุฌูุจ ุญุงูุฉ ุทูุจ
      '/merchant/order-status',
      '/merchant/status',
      '/merchant/check-order',
      '/merchant/order-info',
      '/merchant/order-details',
      
      // API endpoints
      '/api/merchant',
      '/api/orders',
      '/api/status',
      '/v1/merchant',
      '/v1/orders',
      
      // ุทุฑู ุฃุฎุฑู ูุญุชููุฉ
      '/merchant/get-orders',
      '/merchant/fetch-orders',
      '/merchant/order-tracking',
      '/merchant/track-order'
    ];

    const workingEndpoints = [];
    const statusData = [];

    for (const endpoint of testEndpoints) {
      try {
        console.log(`๐ ุงุฎุชุจุงุฑ: ${endpoint}`);
        
        // ุงุฎุชุจุงุฑ GET ุฃููุงู
        const getResponse = await axios.get(`${waseetConfig.baseUrl}${endpoint}`, {
          timeout: 10000,
          headers: {
            'Cookie': token,
            'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36'
          },
          validateStatus: () => true
        });

        if (getResponse.status === 200) {
          console.log(`โ GET ${endpoint} - ูุฌุญ`);
          workingEndpoints.push({ endpoint, method: 'GET', status: getResponse.status });
          
          // ุชุญููู ุงููุญุชูู ููุจุญุซ ุนู ุงูุญุงูุงุช
          const content = typeof getResponse.data === 'string' ? getResponse.data : JSON.stringify(getResponse.data);
          
          // ุงูุจุญุซ ุนู ุงูุญุงูุงุช ุงููุทููุจุฉ
          const expectedStatuses = [
            "ููุฏ ุงูุชูุตูู ุงูู ุงูุฒุจูู",
            "ุชู ุชุบููุฑ ูุญุงูุธุฉ ุงูุฒุจูู",
            "ูุง ูุฑุฏ",
            "ูุบูู",
            "ูุคุฌู",
            "ุงูุบุงุก ุงูุทูุจ",
            "ุฑูุถ ุงูุทูุจ"
          ];

          const foundStatuses = expectedStatuses.filter(status => content.includes(status));
          if (foundStatuses.length > 0) {
            console.log(`   ๐ฏ ูุฌุฏุช ุญุงูุงุช: ${foundStatuses.join(', ')}`);
            statusData.push({ endpoint, statuses: foundStatuses });
          }

          // ุงูุจุญุซ ุนู ูุนุฑูุงุช ุงูุทูุจุงุช
          if (content.includes(testOrder.waseet_order_id)) {
            console.log(`   ๐ฆ ูุฌุฏุช ูุนุฑู ุงูุทูุจ: ${testOrder.waseet_order_id}`);
          }

          // ุงูุจุญุซ ุนู ุฌุฏุงูู ุฃู ููุงุฆู
          if (content.includes('<table>') || content.includes('order') || content.includes('ุทูุจ')) {
            console.log(`   ๐ ูุญุชูู ุนูู ุจูุงูุงุช ุทูุจุงุช`);
          }
        }

        // ุงุฎุชุจุงุฑ POST ูุน ูุนุงููุงุช
        if (endpoint.includes('status') || endpoint.includes('order')) {
          try {
            const postData = new URLSearchParams({
              order_id: testOrder.waseet_order_id,
              id: testOrder.waseet_order_id,
              qr_id: testOrder.waseet_order_id
            });

            const postResponse = await axios.post(`${waseetConfig.baseUrl}${endpoint}`, postData, {
              timeout: 10000,
              headers: {
                'Cookie': token,
                'Content-Type': 'application/x-www-form-urlencoded',
                'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36'
              },
              validateStatus: () => true
            });

            if (postResponse.status === 200) {
              console.log(`โ POST ${endpoint} - ูุฌุญ`);
              workingEndpoints.push({ endpoint, method: 'POST', status: postResponse.status });
            }
          } catch (e) {
            // ุชุฌุงูู ุฃุฎุทุงุก POST
          }
        }

      } catch (error) {
        // ุชุฌุงูู ุงูุฃุฎุทุงุก ูุชุงุจุน
      }
    }

    // 4. ุงุฎุชุจุงุฑ ุทุฑู ุฎุงุตุฉ ุจูุงุกู ุนูู ุงููุซุงุฆู
    console.log('\n๐ ุงุฎุชุจุงุฑ ุทุฑู ุฎุงุตุฉ...');
    
    const specialMethods = [
      {
        name: 'ุฌูุจ ุงูุทูุจุงุช ุจู AJAX',
        url: `${waseetConfig.baseUrl}/merchant/ajax/get-orders`,
        method: 'POST',
        data: { page: 1, limit: 10 }
      },
      {
        name: 'ูุญุต ุญุงูุฉ ุจู AJAX',
        url: `${waseetConfig.baseUrl}/merchant/ajax/check-status`,
        method: 'POST',
        data: { order_id: testOrder.waseet_order_id }
      },
      {
        name: 'API ุฌูุจ ุงูุทูุจุงุช',
        url: `${waseetConfig.baseUrl}/api/v1/merchant/orders`,
        method: 'GET'
      },
      {
        name: 'ุฌูุจ ุงูุญุงูุงุช ุงููุชุงุญุฉ',
        url: `${waseetConfig.baseUrl}/merchant/get-statuses`,
        method: 'GET'
      }
    ];

    for (const method of specialMethods) {
      try {
        console.log(`๐ ${method.name}...`);
        
        let response;
        if (method.method === 'GET') {
          response = await axios.get(method.url, {
            timeout: 10000,
            headers: {
              'Cookie': token,
              'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36'
            },
            validateStatus: () => true
          });
        } else {
          const postData = new URLSearchParams(method.data);
          response = await axios.post(method.url, postData, {
            timeout: 10000,
            headers: {
              'Cookie': token,
              'Content-Type': 'application/x-www-form-urlencoded',
              'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36'
            },
            validateStatus: () => true
          });
        }

        if (response.status === 200) {
          console.log(`โ ${method.name} - ูุฌุญ`);
          console.log(`๐ ุงูุจูุงูุงุช:`, JSON.stringify(response.data, null, 2));
        } else {
          console.log(`โ ${method.name} - ูุดู (${response.status})`);
        }
      } catch (error) {
        console.log(`โ ${method.name} - ุฎุทุฃ: ${error.message}`);
      }
    }

    // 5. ุชูุฑูุฑ ุงููุชุงุฆุฌ
    console.log('\n๐ฏ ุชูุฑูุฑ ุงูุชุดุงู API:');
    console.log('=' * 60);

    console.log(`๐ endpoints ุชุนูู: ${workingEndpoints.length}`);
    if (workingEndpoints.length > 0) {
      console.log('โ endpoints ุงููุงุฌุญุฉ:');
      workingEndpoints.forEach((ep, index) => {
        console.log(`   ${index + 1}. ${ep.method} ${ep.endpoint} (${ep.status})`);
      });
    }

    console.log(`\n๐ endpoints ุชุญุชูู ุนูู ุญุงูุงุช: ${statusData.length}`);
    if (statusData.length > 0) {
      console.log('๐ฏ endpoints ูุน ุงูุญุงูุงุช:');
      statusData.forEach((data, index) => {
        console.log(`   ${index + 1}. ${data.endpoint}:`);
        data.statuses.forEach(status => {
          console.log(`      - ${status}`);
        });
      });
    }

    // 6. ุชูุตูุงุช
    console.log('\n๐ก ุชูุตูุงุช:');
    if (workingEndpoints.length === 0) {
      console.log('๐จ ูู ูุชู ุงูุนุซูุฑ ุนูู API ูุนูู');
      console.log('๐ ูุฌุจ ุงูุชูุงุตู ูุน ุงูุฏุนู ุงูุชููู ูุดุฑูุฉ ุงููุณูุท');
      console.log('๐ ุทูุจ ูุซุงุฆู API ุงูุตุญูุญุฉ');
    } else {
      console.log('โ ุชู ุงูุนุซูุฑ ุนูู endpoints ุชุนูู');
      console.log('๐ง ุทูุฑ ุงููุธุงู ูุงุณุชุฎุฏุงู ูุฐู endpoints');
      if (statusData.length > 0) {
        console.log('๐ฏ ูููู ุฌูุจ ุงูุญุงูุงุช ูู endpoints ุงูููุชุดูุฉ');
      }
    }

    console.log('\n๐ ุงูุชูู ุงูุชุดุงู API!');

    return {
      working_endpoints: workingEndpoints,
      status_endpoints: statusData,
      recommendations: workingEndpoints.length > 0 ? 'ุงุณุชุฎุฏู endpoints ุงูููุชุดูุฉ' : 'ุงุชุตู ุจุงูุฏุนู ุงูุชููู'
    };

  } catch (error) {
    console.error('โ ุฎุทุฃ ูู ุงูุชุดุงู API:', error.message);
    return {
      success: false,
      error: error.message
    };
  }
}

// ุชุดุบูู ุงูุงุฎุชุจุงุฑ
if (require.main === module) {
  discoverWaseetAPI().then(report => {
    console.log('\n๐ ููุฎุต ุงูุงูุชุดุงู:');
    if (report.working_endpoints) {
      console.log(`๐ฏ endpoints ุชุนูู: ${report.working_endpoints.length}`);
      console.log(`๐ endpoints ูุน ุญุงูุงุช: ${report.status_endpoints.length}`);
      console.log(`๐ก ุงูุชูุตูุฉ: ${report.recommendations}`);
    }
  }).catch(error => {
    console.error('โ ุฎุทุฃ ูู ุชุดุบูู ุงูุงูุชุดุงู:', error.message);
  });
}

module.exports = discoverWaseetAPI;
