# 📱 المسار الكامل للإشعارات - من البداية للنهاية

## 🎯 المخطط الشامل

```
┌─────────────────────────────────────────────────────────────────┐
│                    شركة الوسيط (Waseet)                         │
│                  تحديث حالة الطلب (مثلاً: قيد التوصيل)          │
└────────────────────────┬────────────────────────────────────────┘
                         │
                         ▼
┌─────────────────────────────────────────────────────────────────┐
│              Backend - نظام المزامنة التلقائي                   │
│         (integrated_waseet_sync.js - كل 5 دقائق)               │
│                                                                 │
│  1️⃣ جلب الطلبات من الوسيط                                      │
│  2️⃣ مقارنة الحالات مع قاعدة البيانات                           │
│  3️⃣ اكتشاف التغيير: "فعال" → "قيد التوصيل"                    │
│  4️⃣ تحديث قاعدة البيانات                                       │
│  5️⃣ استدعاء sendStatusChangeNotification()                    │
└────────────────────────┬────────────────────────────────────────┘
                         │
                         ▼
┌─────────────────────────────────────────────────────────────────┐
│              فحص ذكي لمنع التكرار                              │
│                                                                 │
│  ✅ هل last_notification_status == newStatus؟                  │
│     ❌ نعم → تخطي الإشعار (تم إرساله بالفعل)                  │
│     ✅ لا → متابعة الإرسال                                     │
└────────────────────────┬────────────────────────────────────────┘
                         │
                         ▼
┌─────────────────────────────────────────────────────────────────┐
│         فلترة الحالات - فقط الحالات المسموحة                   │
│                                                                 │
│  ✅ الحالات المسموحة (21 حالة):                                │
│     - قيد التوصيل الى الزبون (في عهدة المندوب)                │
│     - تم التسليم للزبون                                        │
│     - الغاء الطلب                                              │
│     - ... و 18 حالة أخرى                                       │
│                                                                 │
│  ❌ الحالات المرفوضة:                                          │
│     - فعال (لا إشعار)                                          │
│     - في موقع فرز بغداد (لا إشعار)                             │
└────────────────────────┬────────────────────────────────────────┘
                         │
                         ▼
┌─────────────────────────────────────────────────────────────────┐
│              إرسال الإشعار عبر Firebase                         │
│                                                                 │
│  📤 استدعاء: targetedNotificationService.sendOrderStatusNotification()
│                                                                 │
│  البيانات المرسلة:                                             │
│  - userPhone: رقم هاتف المستخدم                                │
│  - orderId: معرف الطلب                                         │
│  - newStatus: الحالة الجديدة                                   │
│  - customerName: اسم العميل                                    │
│  - waseetStatusText: نص حالة الوسيط                            │
└────────────────────────┬────────────────────────────────────────┘
                         │
                         ▼
┌─────────────────────────────────────────────────────────────────┐
│         البحث عن FCM Token للمستخدم                            │
│                                                                 │
│  1️⃣ البحث في جدول fcm_tokens                                  │
│  2️⃣ البحث عن token نشط (is_active = true)                     │
│  3️⃣ إذا لم يوجد → إيقاف الإرسال                               │
│  4️⃣ إذا وجد → متابعة الإرسال                                  │
└────────────────────────┬────────────────────────────────────────┘
                         │
                         ▼
┌─────────────────────────────────────────────────────────────────┐
│         إنشاء رسالة الإشعار (firebase_admin_service.js)        │
│                                                                 │
│  📋 العنوان (title):                                           │
│     🚗 قيد التوصيل                                             │
│                                                                 │
│  💬 الرسالة (body):                                            │
│     أحمد محمد - (قيد التوصيل)                                  │
│                                                                 │
│  📊 البيانات الإضافية (data):                                 │
│     {                                                          │
│       type: 'order_status_update',                             │
│       orderId: 'order-123',                                    │
│       newStatus: 'قيد التوصيل الى الزبون',                    │
│       customerName: 'أحمد محمد'                                │
│     }                                                          │
│                                                                 │
│  🔊 الإعدادات:                                                │
│     - الصوت: مفعل                                              │
│     - الاهتزاز: مفعل                                           │
│     - الأولوية: عالية                                          │
└────────────────────────┬────────────────────────────────────────┘
                         │
                         ▼
┌─────────────────────────────────────────────────────────────────┐
│              Firebase Cloud Messaging (FCM)                     │
│                                                                 │
│  📤 إرسال الإشعار عبر Firebase                                 │
│  ✅ معرف الرسالة: abc123xyz...                                 │
└────────────────────────┬────────────────────────────────────────┘
                         │
                         ▼
┌─────────────────────────────────────────────────────────────────┐
│              تطبيق Flutter على جهاز المستخدم                   │
│                                                                 │
│  1️⃣ استقبال الإشعار (FCM Service)                             │
│  2️⃣ معالجة الإشعار (_handleForegroundMessage)                 │
│  3️⃣ عرض الإشعار محلياً (Local Notification)                  │
└────────────────────────┬────────────────────────────────────────┘
                         │
                         ▼
┌─────────────────────────────────────────────────────────────────┐
│              🔔 الإشعار يظهر على شاشة المستخدم                │
│                                                                 │
│  ┌─────────────────────────────────────────┐                   │
│  │ 🚗 قيد التوصيل                          │                   │
│  │ أحمد محمد - (قيد التوصيل)              │                   │
│  │ الآن                                    │                   │
│  └─────────────────────────────────────────┘                   │
│                                                                 │
│  ✅ صوت الإشعار يرن                                            │
│  ✅ الهاتف يهتز                                                │
│  ✅ الإشعار يظهر في شريط الإشعارات                             │
└────────────────────────┬────────────────────────────────────────┘
                         │
                         ▼
┌─────────────────────────────────────────────────────────────────┐
│              تحديث آخر حالة إشعار                              │
│                                                                 │
│  UPDATE orders                                                 │
│  SET last_notification_status = 'قيد التوصيل'                 │
│  WHERE id = 'order-123'                                        │
│                                                                 │
│  ✅ هذا يمنع إرسال نفس الإشعار مرة أخرى                       │
└─────────────────────────────────────────────────────────────────┘
```

---

## 📝 أمثلة نصوص الإشعارات

### مثال 1: قيد التوصيل
```
العنوان: 🚗 قيد التوصيل
الرسالة: أحمد محمد - (قيد التوصيل)
```

### مثال 2: تم التسليم
```
العنوان: ✅ تم التسليم
الرسالة: فاطمة علي - (تم التسليم)
```

### مثال 3: إلغاء الطلب
```
العنوان: ❌ إلغاء الطلب
الرسالة: محمد حسن - (الغاء الطلب)
```

### مثال 4: لا يمكن الاتصال
```
العنوان: 📞 لا يمكن الاتصال
الرسالة: سارة أحمد - (لا يمكن الاتصال بالرقم)
```

---

## ⏱️ التوقيت

| الخطوة | الوقت |
|--------|--------|
| تحديث الوسيط | الآن |
| المزامنة التلقائية | كل 5 دقائق |
| اكتشاف التغيير | < 1 ثانية |
| إرسال الإشعار | < 2 ثانية |
| وصول الإشعار للمستخدم | < 5 ثوان |
| **الوقت الإجمالي** | **< 5 دقائق** |

---

## ✅ ضمانات النظام

1. ✅ **إشعار واحد فقط** - لا تكرار
2. ✅ **حالات مسموحة فقط** - لا إشعارات عشوائية
3. ✅ **مصدر واحد** - integrated_waseet_sync.js فقط
4. ✅ **تتبع دقيق** - last_notification_status
5. ✅ **موثوقية عالية** - معالجة الأخطاء الكاملة

