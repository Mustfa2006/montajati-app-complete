# ๐ ุฏููู ูุธุงู Logging ุงูุดุงูู ูุชุชุจุน ูุดููุฉ ุชูุฑุงุฑ ุงูุฃุฑุจุงุญ

## ๐ ูุธุฑุฉ ุนุงูุฉ

ุชู ุฅุถุงูุฉ ูุธุงู Logging ุดุงูู ูู ุฌููุน ุฃูุญุงุก Backend ู Database ูุชุชุจุน ูุดููุฉ ุชูุฑุงุฑ ุงูุฃุฑุจุงุญ ุจุฏูุฉ ุนุงููุฉ ุฌุฏุงู.

## ๐ฏ ุงููุฏู

ูุนุฑูุฉ **ุจุงูุถุจุท** ูู ุฃูู ุชุฃุชู ุงูู 3 ุชุญุฏูุซุงุช ุงูููุฑุฑุฉ ููุฃุฑุจุงุญ:
- ูู ุฃู ูููุ
- ูู ุฃู ุฏุงูุฉุ
- ูู ุฃู ุณุทุฑ ููุฏุ
- ูู ุฃู ููุช ุจุงูุถุจุทุ
- ูู ุฃู ุฌูุณุฉ PostgreSQLุ

## ๐ ููููุงุช ูุธุงู Logging

### 1๏ธโฃ Backend API Logs (`backend/routes/orders.js`)

#### ุงูู Endpoint: `PUT /api/orders/:id/status`

**Logs ุงููุถุงูุฉ:**

```
๐ [REQ_1234567890_abc123] ุจุฏุก ุชุญุฏูุซ ุญุงูุฉ ุงูุทูุจ
โฐ ุงูููุช: 2025-11-07T10:30:45.123Z
๐ ูุนุฑู ุงูุทูุจ: order_123
๐ ุงูุญุงูุฉ ุงูุฌุฏูุฏุฉ: "ููุฏ ุงูุชูุตูู ุงูู ุงูุฒุจูู (ูู ุนูุฏุฉ ุงูููุฏูุจ)"
๐ ุงูุณุจุจ: ุชู ุงูุชุญุฏูุซ ูู ููุญุฉ ุงูุชุญูู
๐ค ุชู ุงูุชุบููุฑ ุจูุงุณุทุฉ: admin
```

**ูุฑุงุญู ุงูุชุชุจุน:**

1. **ุจุฏุก ุงูู Request**
   - ูุนุฑู ูุฑูุฏ: `REQ_${timestamp}_${random}`
   - ุงูููุช ุงูุฏููู
   - ูุนุฑู ุงูุทูุจ
   - ุงูุญุงูุฉ ุงูุฌุฏูุฏุฉ

2. **ุชุญุฏูุซ ุงูุทูุจ ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช**
   - ูุฏุฉ ุงูุชุญุฏูุซ ุจุงูู milliseconds
   - ุงูุญุงูุฉ ุงููุฏููุฉ ูุงูุฌุฏูุฏุฉ
   - ุฑูู ูุงุชู ุงููุณุชุฎุฏู

3. **ุฅุถุงูุฉ ุณุฌู ุงูุชุงุฑูุฎ**
   - ูุฏุฉ ุงูุฅุฏุฑุงุฌ
   - ูุฌุงุญ ุฃู ูุดู

4. **ุฅุถุงูุฉ ุงูููุงุญุธุงุช**
   - ูุฏุฉ ุงูุฅุฏุฑุงุฌ
   - ูุฌุงุญ ุฃู ูุดู

5. **ุฅุฑุณุงู ุงูุทูุจ ูููุณูุท**
   - ูุญุต ุญุงูุฉ ุงููุณูุท
   - ุฅูุดุงุก ุฎุฏูุฉ ุงููุฒุงููุฉ
   - ุฅุฑุณุงู ุงูุทูุจ
   - ุชุญุฏูุซ ุงูุทูุจ ุจุงููุชูุฌุฉ

6. **ููุงูุฉ ุงูู Request**
   - ุงููุฏุฉ ุงูุฅุฌูุงููุฉ
   - ุงูุญุงูุฉ ุงูููุงุฆูุฉ

### 2๏ธโฃ Database Triggers Logs

#### `smart_profit_manager()` Trigger

**Logs ุงููุถุงูุฉ:**

```sql
๐ [TRIGGER_2025-11-07 10:30:45.123_order_123] ุจุฏุก ุชุดุบูู smart_profit_manager trigger
   ๐ ููุน ุงูุนูููุฉ: UPDATE
   ๐ ูุนุฑู ุงูุทูุจ: order_123
   ๐ ุงูุญุงูุฉ ุงููุฏููุฉ: "ูุดุท"
   ๐ ุงูุญุงูุฉ ุงูุฌุฏูุฏุฉ: "ููุฏ ุงูุชูุตูู ุงูู ุงูุฒุจูู (ูู ุนูุฏุฉ ุงูููุฏูุจ)"
   ๐ฐ ุฑุจุญ ุงูุทูุจ: 10500

โ [TRIGGER_...] ุชู ุชุฌุงูุฒ PROTECTION 1 - ุงูุญุงูุฉ ุชุบูุฑุช

โ [TRIGGER_...] ุงูุชูู ุชุดุบูู smart_profit_manager trigger ุจูุฌุงุญ
   ๐ฐ ุงูุฃุฑุจุงุญ ุงููุญููุฉ ุงูุฌุฏูุฏุฉ: 414000
   ๐ ุงูุฃุฑุจุงุญ ุงูููุชุธุฑุฉ ุงูุฌุฏูุฏุฉ: 436000
```

#### `validate_profit_operation()` Trigger

**Logs ุงููุถุงูุฉ:**

```sql
๐ [VALIDATE_2025-11-07 10:30:45.123_07888888888] ุจุฏุก validate_profit_operation trigger
   ๐ฑ ุงููุณุชุฎุฏู: 07888888888
   ๐ฐ ุงูุฃุฑุจุงุญ ุงููุญููุฉ: 414000 โ 414000
   ๐ ุงูุฃุฑุจุงุญ ุงูููุชุธุฑุฉ: 436000 โ 436000
   ๐ ุณูุงู ุงูุนูููุฉ: NULL
   ๐ฑ ุงุณู ุงูุชุทุจูู: postgrest

โ [VALIDATE_...] ุงูุชูู validate_profit_operation trigger ุจูุฌุงุญ
   ๐ฐ ุงูุชุบููุฑ ูู ุงููุญููุฉ: 0
   ๐ ุงูุชุบููุฑ ูู ุงูููุชุธุฑุฉ: 0
```

### 3๏ธโฃ ุฌุฏูู Comprehensive Operation Log

**ุงูุฌุฏูู:** `comprehensive_operation_log`

**ุงูุฃุนูุฏุฉ:**
- `operation_id`: ูุนุฑู ูุฑูุฏ ููุนูููุฉ
- `operation_type`: ููุน ุงูุนูููุฉ (BACKEND_API, TRIGGER, VALIDATION, MONITORING)
- `user_phone`: ุฑูู ูุงุชู ุงููุณุชุฎุฏู
- `order_id`: ูุนุฑู ุงูุทูุจ
- `old_value`: ุงููููุฉ ุงููุฏููุฉ
- `new_value`: ุงููููุฉ ุงูุฌุฏูุฏุฉ
- `change_amount`: ููุฏุงุฑ ุงูุชุบููุฑ
- `source_app`: ูุตุฏุฑ ุงูุชุทุจูู (postgrest, backend_api, database_trigger)
- `source_context`: ุณูุงู ุงููุตุฏุฑ
- `session_pid`: ูุนุฑู ุฌูุณุฉ PostgreSQL
- `session_user`: ูุณุชุฎุฏู ุงูุฌูุณุฉ
- `full_details`: ุชูุงุตูู ูุงููุฉ ุจุตูุบุฉ JSON
- `created_at`: ููุช ุงูุฅูุดุงุก
- `created_at_ms`: ููุช ุงูุฅูุดุงุก ุจุงูู milliseconds

## ๐ ููููุฉ ุงูุจุญุซ ุนู ุงููุดููุฉ

### 1๏ธโฃ ุงูุจุญุซ ูู Railway Logs

```bash
# ุนุฑุถ ุฌููุน ุงูู Logs
railway logs

# ุงูุจุญุซ ุนู ูุนุฑู ุงูุทูุจ
railway logs | grep "order_123"

# ุงูุจุญุซ ุนู ูุนุฑู ุงูู Request
railway logs | grep "REQ_"

# ุงูุจุญุซ ุนู ุงูุฃุฎุทุงุก
railway logs | grep "โ"
```

### 2๏ธโฃ ุงูุจุญุซ ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช

```sql
-- ุงูุจุญุซ ุนู ุฌููุน ุงูุนูููุงุช ูุทูุจ ูุนูู
SELECT * FROM get_operation_timeline('order_123', 100);

-- ุงูุจุญุซ ุนู ุงูุชูุฑุงุฑ
SELECT operation_id, operation_type, change_amount, created_at_ms
FROM comprehensive_operation_log
WHERE order_id = 'order_123'
ORDER BY created_at_ms ASC;

-- ุงูุจุญุซ ุนู ุงูุนูููุงุช ุงููุดุจููุฉ
SELECT * FROM comprehensive_operation_log
WHERE order_id = 'order_123' AND change_amount > 0
ORDER BY created_at_ms ASC;
```

## ๐ ุฎุทูุงุช ุงูุงุฎุชุจุงุฑ

1. **ุฃุถู ุทูุจ ุฌุฏูุฏ** ููุณุชุฎุฏู 07888888888
2. **ุบูุฑ ุญุงูุฉ ุงูุทูุจ** ูู "ูุดุท" ุฅูู "ููุฏ ุงูุชูุตูู ุงูู ุงูุฒุจูู (ูู ุนูุฏุฉ ุงูููุฏูุจ)"
3. **ุงูุชุญ Railway Logs** ูุงุจุญุซ ุนู ูุนุฑู ุงูุทูุจ
4. **ุชุชุจุน ุฌููุน ุงูู Logs** ูู ุงูุจุฏุงูุฉ ุฅูู ุงูููุงูุฉ
5. **ุงุญุณุจ ุนุฏุฏ ุงูุชุญุฏูุซุงุช** ููุฃุฑุจุงุญ
6. **ุชุญูู ูู ุฌุฏูู `comprehensive_operation_log`** ููุชูุงุตูู ุงููุงููุฉ

## ๐ฏ ูุง ุงูุฐู ูุจุญุซ ุนูู

### โ ุงูุณููู ุงูุตุญูุญ:
- 1 ุชุญุฏูุซ ููุท ููุฃุฑุจุงุญ
- 1 Trigger ููุท ูุชู ุชุดุบููู
- 1 ูุนุฑู Request ููุท

### โ ุงูุณููู ุงูุฎุงุทุฆ:
- 3 ุชุญุฏูุซุงุช ููุฃุฑุจุงุญ
- 3 ูุนุฑูุงุช Request ูุฎุชููุฉ
- 3 ุฌูุณุงุช PostgreSQL ูุฎุชููุฉ

## ๐ ูุซุงู ุนูู ุงููุชูุฌุฉ ุงููุชููุนุฉ

```
๐ [REQ_1234567890_abc123] ุจุฏุก ุชุญุฏูุซ ุญุงูุฉ ุงูุทูุจ
   ๐ ูุนุฑู ุงูุทูุจ: order_123
   ๐ ุงูุญุงูุฉ ุงูุฌุฏูุฏุฉ: "ููุฏ ุงูุชูุตูู ุงูู ุงูุฒุจูู (ูู ุนูุฏุฉ ุงูููุฏูุจ)"

โ [REQ_1234567890_abc123] ุชู ุชุญุฏูุซ ุญุงูุฉ ุงูุทูุจ ุจูุฌุงุญ
   โฑ๏ธ ุงููุฏุฉ ุงูุฅุฌูุงููุฉ: 1234ms
   ๐ ุงูุญุงูุฉ: "ูุดุท" โ "ููุฏ ุงูุชูุตูู ุงูู ุงูุฒุจูู (ูู ุนูุฏุฉ ุงูููุฏูุจ)"

๐ [TRIGGER_2025-11-07 10:30:45.123_order_123] ุจุฏุก ุชุดุบูู smart_profit_manager trigger
   ๐ฐ ุฑุจุญ ุงูุทูุจ: 10500

โ [TRIGGER_...] ุงูุชูู ุชุดุบูู smart_profit_manager trigger ุจูุฌุงุญ
   ๐ฐ ุงูุฃุฑุจุงุญ ุงููุญููุฉ ุงูุฌุฏูุฏุฉ: 414000
   ๐ ุงูุฃุฑุจุงุญ ุงูููุชุธุฑุฉ ุงูุฌุฏูุฏุฉ: 436000
```

## ๐ ุงูุฎุทูุงุช ุงูุชุงููุฉ

1. โ ุชู ุฅุถุงูุฉ Logs ูู Backend API
2. โ ุชู ุฅุถุงูุฉ Logs ูู Database Triggers
3. โ ุชู ุฅูุดุงุก ุฌุฏูู `comprehensive_operation_log`
4. โณ **ุงูุขู:** ูู ุจุงูุงุฎุชุจุงุฑ ูุฃุฑุณู ุงูู Logs
5. โณ **ุจุนุฏูุง:** ุณูุญูู ุงูู Logs ููุฌุฏ ุงููุดููุฉ ุจุงูุถุจุท

