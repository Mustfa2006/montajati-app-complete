// ===================================
// Ø§Ø®ØªØ¨Ø§Ø± Ø§ØªØµØ§Ù„ Supabase
// ===================================

require('dotenv').config();
const { createClient } = require('@supabase/supabase-js');

async function testSupabaseConnection() {
  console.log('ğŸ” Ø§Ø®ØªØ¨Ø§Ø± Ø§ØªØµØ§Ù„ Supabase...\n');

  // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ø¨ÙŠØ¦Ø©
  console.log('ğŸ“‹ Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ø¨ÙŠØ¦Ø©:');
  console.log('SUPABASE_URL:', process.env.SUPABASE_URL ? 'âœ… Ù…ÙˆØ¬ÙˆØ¯' : 'âŒ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯');
  console.log('SUPABASE_SERVICE_ROLE_KEY:', process.env.SUPABASE_SERVICE_ROLE_KEY ? 'âœ… Ù…ÙˆØ¬ÙˆØ¯' : 'âŒ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯');
  console.log('');

  if (!process.env.SUPABASE_URL || !process.env.SUPABASE_SERVICE_ROLE_KEY) {
    console.error('âŒ Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ø¨ÙŠØ¦Ø© ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø©!');
    process.exit(1);
  }

  try {
    // Ø¥Ù†Ø´Ø§Ø¡ Ø¹Ù…ÙŠÙ„ Supabase
    const supabase = createClient(
      process.env.SUPABASE_URL,
      process.env.SUPABASE_SERVICE_ROLE_KEY
    );

    console.log('âœ… ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø¹Ù…ÙŠÙ„ Supabase Ø¨Ù†Ø¬Ø§Ø­\n');

    // Ø§Ø®ØªØ¨Ø§Ø± 1: Ø¬Ù„Ø¨ Ø¹Ø¯Ø¯ Ø§Ù„Ø·Ù„Ø¨Ø§Øª
    console.log('ğŸ“Š Ø§Ø®ØªØ¨Ø§Ø± 1: Ø¬Ù„Ø¨ Ø¹Ø¯Ø¯ Ø§Ù„Ø·Ù„Ø¨Ø§Øª...');
    const { count: ordersCount, error: countError } = await supabase
      .from('orders')
      .select('*', { count: 'exact', head: true });

    if (countError) {
      console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø¬Ù„Ø¨ Ø¹Ø¯Ø¯ Ø§Ù„Ø·Ù„Ø¨Ø§Øª:', countError.message);
    } else {
      console.log(`âœ… Ø¹Ø¯Ø¯ Ø§Ù„Ø·Ù„Ø¨Ø§Øª ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª: ${ordersCount}`);
    }
    console.log('');

    // Ø§Ø®ØªØ¨Ø§Ø± 2: Ø¬Ù„Ø¨ Ø·Ù„Ø¨Ø§Øª Ù…Ø³ØªØ®Ø¯Ù… Ù…Ø­Ø¯Ø¯
    console.log('ğŸ“Š Ø§Ø®ØªØ¨Ø§Ø± 2: Ø¬Ù„Ø¨ Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… 07511111111...');
    const { data: userOrders, error: userError } = await supabase
      .from('orders')
      .select('id, customer_name, status, created_at')
      .eq('user_phone', '07511111111')
      .limit(5);

    if (userError) {
      console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø¬Ù„Ø¨ Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…:', userError.message);
    } else {
      console.log(`âœ… Ø¹Ø¯Ø¯ Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…: ${userOrders?.length || 0}`);
      if (userOrders && userOrders.length > 0) {
        console.log('ğŸ“‹ Ø£ÙˆÙ„ 5 Ø·Ù„Ø¨Ø§Øª:');
        userOrders.forEach((order, index) => {
          console.log(`  ${index + 1}. ${order.id} - ${order.customer_name} - ${order.status}`);
        });
      }
    }
    console.log('');

    // Ø§Ø®ØªØ¨Ø§Ø± 3: Ø¬Ù„Ø¨ Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†
    console.log('ğŸ“Š Ø§Ø®ØªØ¨Ø§Ø± 3: Ø¬Ù„Ø¨ Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†...');
    const { count: usersCount, error: usersCountError } = await supabase
      .from('users')
      .select('*', { count: 'exact', head: true });

    if (usersCountError) {
      console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø¬Ù„Ø¨ Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†:', usersCountError.message);
    } else {
      console.log(`âœ… Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª: ${usersCount}`);
    }
    console.log('');

    // Ø§Ø®ØªØ¨Ø§Ø± 4: Ø¬Ù„Ø¨ Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª
    console.log('ğŸ“Š Ø§Ø®ØªØ¨Ø§Ø± 4: Ø¬Ù„Ø¨ Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª...');
    const { count: productsCount, error: productsCountError } = await supabase
      .from('products')
      .select('*', { count: 'exact', head: true });

    if (productsCountError) {
      console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø¬Ù„Ø¨ Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª:', productsCountError.message);
    } else {
      console.log(`âœ… Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª: ${productsCount}`);
    }
    console.log('');

    console.log('âœ… Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª Ø§ÙƒØªÙ…Ù„Øª Ø¨Ù†Ø¬Ø§Ø­!');

  } catch (error) {
    console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù€ Supabase:', error.message);
    console.error('Stack:', error.stack);
    process.exit(1);
  }
}

// ØªØ´ØºÙŠÙ„ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±
testSupabaseConnection();

