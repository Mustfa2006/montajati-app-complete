// ğŸ”” Ø®Ø¯Ù…Ø© Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© - Ù…ØªÙˆØ§ÙÙ‚Ø© Ù…Ø¹ Ù†Ø¸Ø§Ù… FCM Ø§Ù„Ù…Ø­Ø¯Ø«
// ØªØ¯Ø¹Ù… Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ø§Ù„ÙÙˆØ±ÙŠØ© ÙˆØªØ­Ø¯ÙŠØ«Ø§Øª Ø­Ø§Ù„Ø© Ø§Ù„Ø·Ù„Ø¨Ø§Øª

import 'dart:convert';
import 'package:flutter/foundation.dart';
import 'package:firebase_messaging/firebase_messaging.dart';
import 'package:flutter_local_notifications/flutter_local_notifications.dart';
import 'package:http/http.dart' as http;

class NewNotificationService {
  // Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø®Ø¯Ù…Ø©
  static const String _baseUrl = 'http://localhost:3003/api';
  static const Duration _timeout = Duration(seconds: 15);
  
  // Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ù†Ø¸Ø§Ù…
  static FirebaseMessaging? _firebaseMessaging;
  static FlutterLocalNotificationsPlugin? _localNotifications;
  static String? _fcmToken;
  static bool _isInitialized = false;

  // ===================================
  // ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ù†Ø¸Ø§Ù…
  // ===================================

  // ØªÙ‡ÙŠØ¦Ø© Ø®Ø¯Ù…Ø© Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª
  static Future<bool> initialize() async {
    try {
      debugPrint('ğŸ”” ØªÙ‡ÙŠØ¦Ø© Ø®Ø¯Ù…Ø© Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª...');

      // ØªÙ‡ÙŠØ¦Ø© Firebase Messaging
      _firebaseMessaging = FirebaseMessaging.instance;
      
      // Ø·Ù„Ø¨ Ø§Ù„Ø£Ø°ÙˆÙ†Ø§Øª
      NotificationSettings settings = await _firebaseMessaging!.requestPermission(
        alert: true,
        announcement: false,
        badge: true,
        carPlay: false,
        criticalAlert: false,
        provisional: false,
        sound: true,
      );

      if (settings.authorizationStatus == AuthorizationStatus.authorized) {
        debugPrint('âœ… ØªÙ… Ù…Ù†Ø­ Ø£Ø°ÙˆÙ†Ø§Øª Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª');
      } else {
        debugPrint('âš ï¸ Ù„Ù… ÙŠØªÙ… Ù…Ù†Ø­ Ø£Ø°ÙˆÙ†Ø§Øª Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª');
        return false;
      }

      // Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ ØªÙˆÙƒÙ† FCM
      _fcmToken = await _firebaseMessaging!.getToken();
      debugPrint('ğŸ”‘ ØªÙˆÙƒÙ† FCM: $_fcmToken');

      // ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ø§Ù„Ù…Ø­Ù„ÙŠØ©
      await _initializeLocalNotifications();

      // Ø¥Ø¹Ø¯Ø§Ø¯ Ù…Ø¹Ø§Ù„Ø¬Ø§Øª Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª
      _setupNotificationHandlers();

      _isInitialized = true;
      debugPrint('âœ… ØªÙ… ØªÙ‡ÙŠØ¦Ø© Ø®Ø¯Ù…Ø© Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ø¨Ù†Ø¬Ø§Ø­');
      return true;

    } catch (e) {
      debugPrint('âŒ Ø®Ø·Ø£ ÙÙŠ ØªÙ‡ÙŠØ¦Ø© Ø®Ø¯Ù…Ø© Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª: $e');
      return false;
    }
  }

  // ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ø§Ù„Ù…Ø­Ù„ÙŠØ©
  static Future<void> _initializeLocalNotifications() async {
    _localNotifications = FlutterLocalNotificationsPlugin();

    const AndroidInitializationSettings initializationSettingsAndroid =
        AndroidInitializationSettings('@mipmap/ic_launcher');

    const DarwinInitializationSettings initializationSettingsIOS =
        DarwinInitializationSettings(
      requestAlertPermission: true,
      requestBadgePermission: true,
      requestSoundPermission: true,
    );

    const InitializationSettings initializationSettings =
        InitializationSettings(
      android: initializationSettingsAndroid,
      iOS: initializationSettingsIOS,
    );

    await _localNotifications!.initialize(
      initializationSettings,
      onDidReceiveNotificationResponse: _onNotificationTapped,
    );
  }

  // Ø¥Ø¹Ø¯Ø§Ø¯ Ù…Ø¹Ø§Ù„Ø¬Ø§Øª Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª
  static void _setupNotificationHandlers() {
    // Ù…Ø¹Ø§Ù„Ø¬ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª ÙÙŠ Ø§Ù„Ù…Ù‚Ø¯Ù…Ø©
    FirebaseMessaging.onMessage.listen((RemoteMessage message) {
      debugPrint('ğŸ“± Ø¥Ø´Ø¹Ø§Ø± ÙÙŠ Ø§Ù„Ù…Ù‚Ø¯Ù…Ø©: ${message.notification?.title}');
      _showLocalNotification(message);
    });

    // Ù…Ø¹Ø§Ù„Ø¬ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª ÙÙŠ Ø§Ù„Ø®Ù„ÙÙŠØ©
    FirebaseMessaging.onMessageOpenedApp.listen((RemoteMessage message) {
      debugPrint('ğŸ“± ØªÙ… ÙØªØ­ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±: ${message.notification?.title}');
      _handleNotificationTap(message);
    });

    // Ù…Ø¹Ø§Ù„Ø¬ ØªØ­Ø¯ÙŠØ« Ø§Ù„ØªÙˆÙƒÙ†
    _firebaseMessaging!.onTokenRefresh.listen((String token) {
      debugPrint('ğŸ”„ ØªÙ… ØªØ­Ø¯ÙŠØ« ØªÙˆÙƒÙ† FCM: $token');
      _fcmToken = token;
      _updateTokenOnServer(token);
    });
  }

  // ===================================
  // Ø¯ÙˆØ§Ù„ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª
  // ===================================

  // Ø¹Ø±Ø¶ Ø¥Ø´Ø¹Ø§Ø± Ù…Ø­Ù„ÙŠ
  static Future<void> _showLocalNotification(RemoteMessage message) async {
    if (_localNotifications == null) return;

    const AndroidNotificationDetails androidPlatformChannelSpecifics =
        AndroidNotificationDetails(
      'montajati_orders',
      'Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ø§Ù„Ø·Ù„Ø¨Ø§Øª',
      channelDescription: 'Ø¥Ø´Ø¹Ø§Ø±Ø§Øª ØªØ­Ø¯ÙŠØ«Ø§Øª Ø­Ø§Ù„Ø© Ø§Ù„Ø·Ù„Ø¨Ø§Øª',
      importance: Importance.max,
      priority: Priority.high,
      showWhen: true,
    );

    const DarwinNotificationDetails iOSPlatformChannelSpecifics =
        DarwinNotificationDetails(
      presentAlert: true,
      presentBadge: true,
      presentSound: true,
    );

    const NotificationDetails platformChannelSpecifics = NotificationDetails(
      android: androidPlatformChannelSpecifics,
      iOS: iOSPlatformChannelSpecifics,
    );

    await _localNotifications!.show(
      DateTime.now().millisecondsSinceEpoch.remainder(100000),
      message.notification?.title ?? 'Ù…Ù†ØªØ¬Ø§ØªÙŠ',
      message.notification?.body ?? 'Ù„Ø¯ÙŠÙƒ Ø¥Ø´Ø¹Ø§Ø± Ø¬Ø¯ÙŠØ¯',
      platformChannelSpecifics,
      payload: json.encode(message.data),
    );
  }

  // Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ù†Ù‚Ø± Ø¹Ù„Ù‰ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±
  static void _onNotificationTapped(NotificationResponse response) {
    if (response.payload != null) {
      try {
        final data = json.decode(response.payload!);
        _handleNotificationData(data);
      } catch (e) {
        debugPrint('âŒ Ø®Ø·Ø£ ÙÙŠ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±: $e');
      }
    }
  }

  // Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ù†Ù‚Ø± Ø¹Ù„Ù‰ Ø¥Ø´Ø¹Ø§Ø± Firebase
  static void _handleNotificationTap(RemoteMessage message) {
    _handleNotificationData(message.data);
  }

  // Ù…Ø¹Ø§Ù„Ø¬Ø© Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±
  static void _handleNotificationData(Map<String, dynamic> data) {
    debugPrint('ğŸ“‹ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±: $data');
    
    final type = data['type'];
    
    switch (type) {
      case 'order_status':
        final orderId = data['orderId'];
        final status = data['status'];
        debugPrint('ğŸ“¦ ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ø·Ù„Ø¨: $orderId -> $status');
        // ÙŠÙ…ÙƒÙ† Ø¥Ø¶Ø§ÙØ© Ø§Ù„ØªÙ†Ù‚Ù„ Ø¥Ù„Ù‰ ØµÙØ­Ø© ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨ Ù‡Ù†Ø§
        break;
        
      case 'welcome':
        debugPrint('ğŸ‘‹ Ø¥Ø´Ø¹Ø§Ø± ØªØ±Ø­ÙŠØ¨');
        // ÙŠÙ…ÙƒÙ† Ø¥Ø¶Ø§ÙØ© Ø§Ù„ØªÙ†Ù‚Ù„ Ø¥Ù„Ù‰ Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© Ù‡Ù†Ø§
        break;
        
      case 'promotion':
        debugPrint('ğŸ‰ Ø¥Ø´Ø¹Ø§Ø± Ø¹Ø±Ø¶ Ø®Ø§Øµ');
        // ÙŠÙ…ÙƒÙ† Ø¥Ø¶Ø§ÙØ© Ø§Ù„ØªÙ†Ù‚Ù„ Ø¥Ù„Ù‰ ØµÙØ­Ø© Ø§Ù„Ø¹Ø±ÙˆØ¶ Ù‡Ù†Ø§
        break;
        
      default:
        debugPrint('ğŸ“¢ Ø¥Ø´Ø¹Ø§Ø± Ø¹Ø§Ù…');
        break;
    }
  }

  // ===================================
  // Ø¯ÙˆØ§Ù„ Ø§Ù„ØªÙØ§Ø¹Ù„ Ù…Ø¹ Ø§Ù„Ø®Ø§Ø¯Ù…
  // ===================================

  // ØªØ­Ø¯ÙŠØ« Ø§Ù„ØªÙˆÙƒÙ† Ø¹Ù„Ù‰ Ø§Ù„Ø®Ø§Ø¯Ù…
  static Future<void> _updateTokenOnServer(String token) async {
    try {
      // ÙŠÙ…ÙƒÙ† Ø¥Ø¶Ø§ÙØ© Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ØªÙˆÙƒÙ† Ø¥Ù„Ù‰ Ø§Ù„Ø®Ø§Ø¯Ù… Ù‡Ù†Ø§
      debugPrint('ğŸ”„ ØªØ­Ø¯ÙŠØ« Ø§Ù„ØªÙˆÙƒÙ† Ø¹Ù„Ù‰ Ø§Ù„Ø®Ø§Ø¯Ù…: $token');
      
      // Ù…Ø«Ø§Ù„ Ø¹Ù„Ù‰ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ØªÙˆÙƒÙ†
      // await _sendPostRequest('/update-fcm-token', {'token': token});
      
    } catch (e) {
      debugPrint('âŒ Ø®Ø·Ø£ ÙÙŠ ØªØ­Ø¯ÙŠØ« Ø§Ù„ØªÙˆÙƒÙ†: $e');
    }
  }

  // ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù„Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª
  static Future<bool> registerUserForNotifications(int userId) async {
    try {
      if (!_isInitialized || _fcmToken == null) {
        debugPrint('âš ï¸ Ø®Ø¯Ù…Ø© Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª ØºÙŠØ± Ù…Ù‡ÙŠØ£Ø©');
        return false;
      }

      final response = await _sendPostRequest('/register-notifications', {
        'userId': userId,
        'fcmToken': _fcmToken,
      });

      if (response['success'] == true) {
        debugPrint('âœ… ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù„Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª');
        return true;
      } else {
        debugPrint('âŒ ÙØ´Ù„ ÙÙŠ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù„Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª');
        return false;
      }
    } catch (e) {
      debugPrint('âŒ Ø®Ø·Ø£ ÙÙŠ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù„Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª: $e');
      return false;
    }
  }

  // Ø¥Ù„ØºØ§Ø¡ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…Ù† Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª
  static Future<bool> unregisterUserFromNotifications(int userId) async {
    try {
      final response = await _sendPostRequest('/unregister-notifications', {
        'userId': userId,
      });

      if (response['success'] == true) {
        debugPrint('âœ… ØªÙ… Ø¥Ù„ØºØ§Ø¡ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…Ù† Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª');
        return true;
      } else {
        debugPrint('âŒ ÙØ´Ù„ ÙÙŠ Ø¥Ù„ØºØ§Ø¡ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…Ù† Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª');
        return false;
      }
    } catch (e) {
      debugPrint('âŒ Ø®Ø·Ø£ ÙÙŠ Ø¥Ù„ØºØ§Ø¡ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…Ù† Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª: $e');
      return false;
    }
  }

  // ===================================
  // Ø¯ÙˆØ§Ù„ Ù…Ø³Ø§Ø¹Ø¯Ø©
  // ===================================

  // Ø¥Ø±Ø³Ø§Ù„ Ø·Ù„Ø¨ POST
  static Future<Map<String, dynamic>> _sendPostRequest(String endpoint, Map<String, dynamic> data) async {
    try {
      final response = await http.post(
        Uri.parse('$_baseUrl$endpoint'),
        headers: {
          'Content-Type': 'application/json',
          'Accept': 'application/json',
        },
        body: json.encode(data),
      ).timeout(_timeout);

      if (response.statusCode == 200 || response.statusCode == 201) {
        return json.decode(response.body);
      } else {
        throw Exception('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø®Ø§Ø¯Ù…: ${response.statusCode}');
      }
    } catch (e) {
      debugPrint('âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø·Ù„Ø¨: $e');
      rethrow;
    }
  }

  // Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ ØªÙˆÙƒÙ† FCM
  static String? getFCMToken() {
    return _fcmToken;
  }

  // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø­Ø§Ù„Ø© Ø§Ù„ØªÙ‡ÙŠØ¦Ø©
  static bool isInitialized() {
    return _isInitialized;
  }

  // Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø®Ø¯Ù…Ø©
  static Map<String, dynamic> getServiceInfo() {
    return {
      'isInitialized': _isInitialized,
      'hasFCMToken': _fcmToken != null,
      'fcmToken': _fcmToken,
    };
  }
}
