// ===================================
// Ø®Ø¯Ù…Ø© Firebase Cloud Messaging Ø§Ù„Ø§Ø­ØªØ±Ø§ÙÙŠØ©
// Professional FCM Service for Push Notifications
// ===================================

import 'dart:convert';
import 'dart:io';
import 'package:flutter/foundation.dart';
import 'package:firebase_core/firebase_core.dart';
import 'package:firebase_messaging/firebase_messaging.dart';
import 'package:flutter_local_notifications/flutter_local_notifications.dart';
import 'package:shared_preferences/shared_preferences.dart';
import 'package:supabase_flutter/supabase_flutter.dart';
import 'package:device_info_plus/device_info_plus.dart';
import '../firebase_options.dart';

class FCMService {
  static final FCMService _instance = FCMService._internal();
  factory FCMService() => _instance;
  FCMService._internal();

  // Firebase Messaging instance
  FirebaseMessaging? _messaging;
  
  // Local Notifications
  final FlutterLocalNotificationsPlugin _localNotifications = 
      FlutterLocalNotificationsPlugin();
  
  // Supabase client
  final SupabaseClient _supabase = Supabase.instance.client;
  
  // Service state
  bool _isInitialized = false;
  String? _currentToken;
  
  // Getters
  bool get isInitialized => _isInitialized;
  String? get currentToken => _currentToken;

  /// âœ… ØªÙ‡ÙŠØ¦Ø© Ø®Ø¯Ù…Ø© FCM Ù…Ø­Ø³Ù†Ø© Ù…Ø¹ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø£ÙØ¶Ù„ Ù„Ù„Ø£Ø®Ø·Ø§Ø¡
  Future<bool> initialize() async {
    try {
      debugPrint('ğŸ”¥ Ø¨Ø¯Ø¡ ØªÙ‡ÙŠØ¦Ø© Firebase Cloud Messaging...');

      // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØªÙˆÙØ± Ø§Ù„Ø®Ø¯Ù…Ø§Øª
      if (!kIsWeb && Platform.isIOS) {
        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª iOS
        debugPrint('ğŸ“± ØªØ´ØºÙŠÙ„ Ø¹Ù„Ù‰ iOS - Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª...');
      } else if (!kIsWeb && Platform.isAndroid) {
        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Android
        debugPrint('ğŸ¤– ØªØ´ØºÙŠÙ„ Ø¹Ù„Ù‰ Android - Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª...');
      }

      // ØªÙ‡ÙŠØ¦Ø© Firebase Ù…Ø¹ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø£Ø®Ø·Ø§Ø¡
      try {
        await Firebase.initializeApp(
          options: DefaultFirebaseOptions.currentPlatform,
        );
        debugPrint('âœ… ØªÙ… ØªÙ‡ÙŠØ¦Ø© Firebase Ø¨Ù†Ø¬Ø§Ø­');
      } catch (firebaseError) {
        debugPrint('âŒ Ø®Ø·Ø£ ÙÙŠ ØªÙ‡ÙŠØ¦Ø© Firebase: $firebaseError');
        return false;
      }

      _messaging = FirebaseMessaging.instance;
      
      // Ø·Ù„Ø¨ Ø§Ù„Ø£Ø°ÙˆÙ†Ø§Øª
      await _requestPermissions();
      
      // ØªÙ‡ÙŠØ¦Ø© Local Notifications
      await _initializeLocalNotifications();
      
      // Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ FCM Token
      await _getFCMToken();
      
      // Ø¥Ø¹Ø¯Ø§Ø¯ Ù…Ø¹Ø§Ù„Ø¬Ø§Øª Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª
      _setupMessageHandlers();
      
      _isInitialized = true;
      debugPrint('âœ… ØªÙ… ØªÙ‡ÙŠØ¦Ø© FCM Ø¨Ù†Ø¬Ø§Ø­');
      
      return true;
    } catch (e) {
      debugPrint('âŒ Ø®Ø·Ø£ ÙÙŠ ØªÙ‡ÙŠØ¦Ø© FCM: $e');
      return false;
    }
  }

  /// Ø·Ù„Ø¨ Ø£Ø°ÙˆÙ†Ø§Øª Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª
  Future<void> _requestPermissions() async {
    if (_messaging == null) return;
    
    final settings = await _messaging!.requestPermission(
      alert: true,
      announcement: false,
      badge: true,
      carPlay: false,
      criticalAlert: false,
      provisional: false,
      sound: true,
    );
    
    debugPrint('ğŸ”” Ø­Ø§Ù„Ø© Ø£Ø°ÙˆÙ†Ø§Øª Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª: ${settings.authorizationStatus}');
  }

  /// ØªÙ‡ÙŠØ¦Ø© Local Notifications
  Future<void> _initializeLocalNotifications() async {
    const androidSettings = AndroidInitializationSettings('@drawable/ic_notification');
    const iosSettings = DarwinInitializationSettings(
      requestAlertPermission: true,
      requestBadgePermission: true,
      requestSoundPermission: true,
    );
    
    const initSettings = InitializationSettings(
      android: androidSettings,
      iOS: iosSettings,
    );
    
    await _localNotifications.initialize(
      initSettings,
      onDidReceiveNotificationResponse: _onNotificationTapped,
    );
    
    // Ø¥Ù†Ø´Ø§Ø¡ notification channel Ù„Ù„Ø£Ù†Ø¯Ø±ÙˆÙŠØ¯
    if (Platform.isAndroid) {
      await _createNotificationChannel();
    }
  }

  /// Ø¥Ù†Ø´Ø§Ø¡ notification channel Ù„Ù„Ø£Ù†Ø¯Ø±ÙˆÙŠØ¯
  Future<void> _createNotificationChannel() async {
    const channel = AndroidNotificationChannel(
      'montajati_notifications',
      'Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ù…Ù†ØªØ¬Ø§ØªÙŠ',
      description: 'Ø¥Ø´Ø¹Ø§Ø±Ø§Øª ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ø·Ù„Ø¨Ø§Øª',
      importance: Importance.high,
      enableVibration: true,
      playSound: true,
    );
    
    await _localNotifications
        .resolvePlatformSpecificImplementation<AndroidFlutterLocalNotificationsPlugin>()
        ?.createNotificationChannel(channel);
  }

  /// Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ FCM Token
  Future<void> _getFCMToken() async {
    try {
      if (_messaging == null) return;
      
      _currentToken = await _messaging!.getToken();
      
      if (_currentToken != null) {
        debugPrint('ğŸ”‘ FCM Token: ${_currentToken!.substring(0, 20)}...');
        
        // Ø­ÙØ¸ Token ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
        await _saveFCMToken(_currentToken!);
        
        // Ø§Ù„Ø§Ø³ØªÙ…Ø§Ø¹ Ù„ØªØ­Ø¯ÙŠØ«Ø§Øª Token
        _messaging!.onTokenRefresh.listen((newToken) {
          debugPrint('ğŸ”„ ØªÙ… ØªØ­Ø¯ÙŠØ« FCM Token');
          _currentToken = newToken;
          _saveFCMToken(newToken);
        });
      }
    } catch (e) {
      debugPrint('âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ FCM Token: $e');
    }
  }

  /// Ø­ÙØ¸ FCM Token ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
  Future<void> _saveFCMToken(String token) async {
    try {
      final prefs = await SharedPreferences.getInstance();
      final userPhone = prefs.getString('user_phone');
      
      if (userPhone == null || userPhone.isEmpty) {
        debugPrint('âš ï¸ Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø±Ù‚Ù… Ù‡Ø§ØªÙ Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù… - Ù„Ù† ÙŠØªÙ… Ø­ÙØ¸ FCM Token');
        return;
      }
      
      // Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø¬Ù‡Ø§Ø²
      final deviceInfo = await _getDeviceInfo();
      
      // âœ… Ø­ÙØ¸ Token ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø¹ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø§Ø³ØªØ¬Ø§Ø¨Ø©
      final response = await _supabase.rpc('upsert_fcm_token', params: {
        'p_user_phone': userPhone,
        'p_fcm_token': token,
        'p_device_info': deviceInfo,
      });

      if (response != null) {
        debugPrint('âœ… ØªÙ… Ø­ÙØ¸ FCM Token Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…: $userPhone');
      } else {
        debugPrint('âš ï¸ ØªÙ… Ø­ÙØ¸ FCM Token ÙˆÙ„ÙƒÙ† Ø¨Ø¯ÙˆÙ† Ø§Ø³ØªØ¬Ø§Ø¨Ø© Ù…Ù† Ø§Ù„Ø®Ø§Ø¯Ù…');
      }
      
    } catch (e) {
      debugPrint('âŒ Ø®Ø·Ø£ ÙÙŠ Ø­ÙØ¸ FCM Token: $e');
    }
  }

  /// Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø¬Ù‡Ø§Ø²
  Future<Map<String, dynamic>> _getDeviceInfo() async {
    final deviceInfo = DeviceInfoPlugin();
    
    try {
      if (Platform.isAndroid) {
        final androidInfo = await deviceInfo.androidInfo;
        return {
          'platform': 'android',
          'model': androidInfo.model,
          'manufacturer': androidInfo.manufacturer,
          'version': androidInfo.version.release,
          'sdk_int': androidInfo.version.sdkInt,
        };
      } else if (Platform.isIOS) {
        final iosInfo = await deviceInfo.iosInfo;
        return {
          'platform': 'ios',
          'model': iosInfo.model,
          'name': iosInfo.name,
          'version': iosInfo.systemVersion,
        };
      }
    } catch (e) {
      debugPrint('âš ï¸ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø¬Ù‡Ø§Ø²: $e');
    }
    
    return {
      'platform': Platform.operatingSystem,
      'timestamp': DateTime.now().toIso8601String(),
    };
  }

  /// Ø¥Ø¹Ø¯Ø§Ø¯ Ù…Ø¹Ø§Ù„Ø¬Ø§Øª Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª
  void _setupMessageHandlers() {
    if (_messaging == null) return;
    
    // Ù…Ø¹Ø§Ù„Ø¬ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª ÙÙŠ Ø§Ù„Ù…Ù‚Ø¯Ù…Ø©
    FirebaseMessaging.onMessage.listen(_handleForegroundMessage);
    
    // Ù…Ø¹Ø§Ù„Ø¬ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ø¹Ù†Ø¯ Ø§Ù„Ù†Ù‚Ø± (Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ ÙÙŠ Ø§Ù„Ø®Ù„ÙÙŠØ©)
    FirebaseMessaging.onMessageOpenedApp.listen(_handleMessageOpenedApp);
    
    // Ù…Ø¹Ø§Ù„Ø¬ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ø¹Ù†Ø¯ ÙØªØ­ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ù…Ù† Ø¥Ø´Ø¹Ø§Ø±
    _handleInitialMessage();
  }

  /// Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª ÙÙŠ Ø§Ù„Ù…Ù‚Ø¯Ù…Ø©
  Future<void> _handleForegroundMessage(RemoteMessage message) async {
    debugPrint('ğŸ“± ØªÙ… Ø§Ø³ØªÙ„Ø§Ù… Ø¥Ø´Ø¹Ø§Ø± ÙÙŠ Ø§Ù„Ù…Ù‚Ø¯Ù…Ø©: ${message.messageId}');
    
    // Ø¹Ø±Ø¶ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø± Ù…Ø­Ù„ÙŠØ§Ù‹
    await _showLocalNotification(message);
  }

  /// Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ù†Ù‚Ø± Ø¹Ù„Ù‰ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±
  void _handleMessageOpenedApp(RemoteMessage message) {
    debugPrint('ğŸ‘† ØªÙ… Ø§Ù„Ù†Ù‚Ø± Ø¹Ù„Ù‰ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±: ${message.messageId}');
    _processNotificationData(message.data);
  }

  /// Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø¥Ø´Ø¹Ø§Ø± Ø§Ù„Ø£ÙˆÙ„ÙŠ Ø¹Ù†Ø¯ ÙØªØ­ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚
  Future<void> _handleInitialMessage() async {
    final initialMessage = await _messaging?.getInitialMessage();
    if (initialMessage != null) {
      debugPrint('ğŸš€ ØªÙ… ÙØªØ­ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ù…Ù† Ø¥Ø´Ø¹Ø§Ø±: ${initialMessage.messageId}');
      _processNotificationData(initialMessage.data);
    }
  }

  /// Ø¹Ø±Ø¶ Ø¥Ø´Ø¹Ø§Ø± Ù…Ø­Ù„ÙŠ
  Future<void> _showLocalNotification(RemoteMessage message) async {
    const androidDetails = AndroidNotificationDetails(
      'montajati_notifications',
      'Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ù…Ù†ØªØ¬Ø§ØªÙŠ',
      channelDescription: 'Ø¥Ø´Ø¹Ø§Ø±Ø§Øª ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ø·Ù„Ø¨Ø§Øª',
      importance: Importance.high,
      priority: Priority.high,
      showWhen: true,
      enableVibration: true,
      playSound: true,
    );
    
    const iosDetails = DarwinNotificationDetails(
      presentAlert: true,
      presentBadge: true,
      presentSound: true,
    );
    
    const details = NotificationDetails(
      android: androidDetails,
      iOS: iosDetails,
    );
    
    await _localNotifications.show(
      message.hashCode,
      message.notification?.title ?? 'Ø¥Ø´Ø¹Ø§Ø± Ø¬Ø¯ÙŠØ¯',
      message.notification?.body ?? 'Ù„Ø¯ÙŠÙƒ ØªØ­Ø¯ÙŠØ« Ø¬Ø¯ÙŠØ¯',
      details,
      payload: jsonEncode(message.data),
    );
  }

  /// Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ù†Ù‚Ø± Ø¹Ù„Ù‰ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø± Ø§Ù„Ù…Ø­Ù„ÙŠ
  void _onNotificationTapped(NotificationResponse response) {
    if (response.payload != null) {
      final data = jsonDecode(response.payload!);
      _processNotificationData(data);
    }
  }

  /// Ù…Ø¹Ø§Ù„Ø¬Ø© Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±
  void _processNotificationData(Map<String, dynamic> data) {
    debugPrint('ğŸ“Š Ù…Ø¹Ø§Ù„Ø¬Ø© Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±: $data');
    
    // ÙŠÙ…ÙƒÙ† Ø¥Ø¶Ø§ÙØ© Ù…Ù†Ø·Ù‚ Ø§Ù„ØªÙ†Ù‚Ù„ Ù‡Ù†Ø§ Ø­Ø³Ø¨ Ù†ÙˆØ¹ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±
    final orderId = data['orderId'] ?? data['order_id'];
    if (orderId != null) {
      // Ø§Ù„ØªÙ†Ù‚Ù„ Ø¥Ù„Ù‰ ØµÙØ­Ø© ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨
      debugPrint('ğŸ”— Ø§Ù„ØªÙ†Ù‚Ù„ Ø¥Ù„Ù‰ Ø§Ù„Ø·Ù„Ø¨: $orderId');
    }
  }

  /// ØªØ­Ø¯ÙŠØ« Ø¢Ø®Ø± Ø§Ø³ØªØ®Ø¯Ø§Ù… Ù„Ù„Ù€ Token
  Future<void> updateTokenLastUsed() async {
    if (_currentToken == null) return;
    
    try {
      final prefs = await SharedPreferences.getInstance();
      final userPhone = prefs.getString('user_phone');
      
      if (userPhone != null) {
        await _supabase
            .from('fcm_tokens')
            .update({'last_used_at': DateTime.now().toIso8601String()})
            .eq('user_phone', userPhone)
            .eq('fcm_token', _currentToken!);
      }
    } catch (e) {
      debugPrint('âš ï¸ Ø®Ø·Ø£ ÙÙŠ ØªØ­Ø¯ÙŠØ« Ø¢Ø®Ø± Ø§Ø³ØªØ®Ø¯Ø§Ù… Ù„Ù„Ù€ Token: $e');
    }
  }

  /// ØªØ³Ø¬ÙŠÙ„ FCM Token Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø­Ø§Ù„ÙŠ
  static Future<bool> registerCurrentUserToken() async {
    final instance = FCMService();

    if (!instance.isInitialized) {
      await instance.initialize();
    }

    if (instance.currentToken == null) {
      debugPrint('âŒ Ù„Ø§ ÙŠÙˆØ¬Ø¯ FCM Token Ù„Ù„ØªØ³Ø¬ÙŠÙ„');
      return false;
    }

    try {
      // Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø­Ø§Ù„ÙŠ
      final user = Supabase.instance.client.auth.currentUser;
      if (user == null) {
        debugPrint('âŒ Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø³ØªØ®Ø¯Ù… Ù…Ø³Ø¬Ù„ Ø¯Ø®ÙˆÙ„');
        return false;
      }

      // Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ Ù…Ù† Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†
      final userResponse = await Supabase.instance.client
          .from('users')
          .select('phone')
          .eq('id', user.id)
          .single();

      final userPhone = userResponse['phone'] as String?;
      if (userPhone == null || userPhone.isEmpty) {
        debugPrint('âŒ Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø±Ù‚Ù… Ù‡Ø§ØªÙ Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…');
        return false;
      }

      // ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ù€ Token ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
      await Supabase.instance.client.from('fcm_tokens').upsert({
        'user_phone': userPhone,
        'fcm_token': instance.currentToken,
        'device_info': {'platform': 'Flutter', 'app': 'Montajati'},
        'is_active': true,
        'created_at': DateTime.now().toIso8601String(),
        'updated_at': DateTime.now().toIso8601String(),
        'last_used_at': DateTime.now().toIso8601String(),
      });

      debugPrint('âœ… ØªÙ… ØªØ³Ø¬ÙŠÙ„ FCM Token Ø¨Ù†Ø¬Ø§Ø­ Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…: $userPhone');
      return true;

    } catch (e) {
      debugPrint('âŒ Ø®Ø·Ø£ ÙÙŠ ØªØ³Ø¬ÙŠÙ„ FCM Token: $e');
      return false;
    }
  }

  /// Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø®Ø¯Ù…Ø©
  Map<String, dynamic> getServiceInfo() {
    return {
      'isInitialized': _isInitialized,
      'hasToken': _currentToken != null,
      'tokenPreview': _currentToken?.substring(0, 20),
    };
  }
}
