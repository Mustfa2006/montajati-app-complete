# 📱 تجربة المستخدم - كيف يستقبل الإشعارات

## 🎯 السيناريوهات المختلفة

### السيناريو 1️⃣: التطبيق مفتوح (في المقدمة)

```
┌─────────────────────────────────────────────────────────────────┐
│                    Firebase Cloud Messaging                     │
│                   يرسل الإشعار للتطبيق                         │
└────────────────────────┬────────────────────────────────────────┘
                         │
                         ▼
┌─────────────────────────────────────────────────────────────────┐
│              FCM Service في Flutter                            │
│                                                                 │
│  _handleForegroundMessage() يتم استدعاؤها                      │
│  (معالج الإشعارات عندما يكون التطبيق مفتوح)                   │
└────────────────────────┬────────────────────────────────────────┘
                         │
                         ▼
┌─────────────────────────────────────────────────────────────────┐
│              عرض الإشعار محلياً                                │
│                                                                 │
│  _showLocalNotification() يتم استدعاؤها                        │
│                                                                 │
│  ┌─────────────────────────────────────────┐                   │
│  │ 🚗 قيد التوصيل                          │                   │
│  │ أحمد محمد - (قيد التوصيل)              │                   │
│  │ الآن                                    │                   │
│  └─────────────────────────────────────────┘                   │
│                                                                 │
│  ✅ الإشعار يظهر في أعلى الشاشة                               │
│  ✅ صوت الإشعار يرن                                            │
│  ✅ الهاتف يهتز                                                │
└────────────────────────┬────────────────────────────────────────┘
                         │
                         ▼
┌─────────────────────────────────────────────────────────────────┐
│              النقر على الإشعار                                 │
│                                                                 │
│  _onNotificationTapped() يتم استدعاؤها                         │
│  _processNotificationData() يتم استدعاؤها                      │
│                                                                 │
│  ✅ التنقل إلى صفحة تفاصيل الطلب                              │
│  ✅ عرض الحالة الجديدة                                        │
└─────────────────────────────────────────────────────────────────┘
```

---

### السيناريو 2️⃣: التطبيق في الخلفية

```
┌─────────────────────────────────────────────────────────────────┐
│                    Firebase Cloud Messaging                     │
│                   يرسل الإشعار للتطبيق                         │
└────────────────────────┬────────────────────────────────────────┘
                         │
                         ▼
┌─────────────────────────────────────────────────────────────────┐
│              نظام التشغيل (Android/iOS)                        │
│                                                                 │
│  يعرض الإشعار في شريط الإشعارات                               │
│                                                                 │
│  ┌─────────────────────────────────────────┐                   │
│  │ 🚗 قيد التوصيل                          │                   │
│  │ أحمد محمد - (قيد التوصيل)              │                   │
│  │ الآن                                    │                   │
│  └─────────────────────────────────────────┘                   │
│                                                                 │
│  ✅ صوت الإشعار يرن                                            │
│  ✅ الهاتف يهتز                                                │
│  ✅ الإشعار يبقى في شريط الإشعارات                             │
└────────────────────────┬────────────────────────────────────────┘
                         │
                         ▼
┌─────────────────────────────────────────────────────────────────┐
│              المستخدم ينقر على الإشعار                        │
│                                                                 │
│  _handleMessageOpenedApp() يتم استدعاؤها                       │
│  _processNotificationData() يتم استدعاؤها                      │
└────────────────────────┬────────────────────────────────────────┘
                         │
                         ▼
┌─────────────────────────────────────────────────────────────────┐
│              فتح التطبيق                                       │
│                                                                 │
│  ✅ التطبيق يفتح                                               │
│  ✅ التنقل إلى صفحة تفاصيل الطلب                              │
│  ✅ عرض الحالة الجديدة                                        │
└─────────────────────────────────────────────────────────────────┘
```

---

### السيناريو 3️⃣: التطبيق مغلق تماماً

```
┌─────────────────────────────────────────────────────────────────┐
│                    Firebase Cloud Messaging                     │
│                   يرسل الإشعار للتطبيق                         │
└────────────────────────┬────────────────────────────────────────┘
                         │
                         ▼
┌─────────────────────────────────────────────────────────────────┐
│              نظام التشغيل (Android/iOS)                        │
│                                                                 │
│  يعرض الإشعار في شريط الإشعارات                               │
│                                                                 │
│  ┌─────────────────────────────────────────┐                   │
│  │ 🚗 قيد التوصيل                          │                   │
│  │ أحمد محمد - (قيد التوصيل)              │                   │
│  │ الآن                                    │                   │
│  └─────────────────────────────────────────┘                   │
│                                                                 │
│  ✅ صوت الإشعار يرن                                            │
│  ✅ الهاتف يهتز                                                │
│  ✅ الإشعار يبقى في شريط الإشعارات                             │
└────────────────────────┬────────────────────────────────────────┘
                         │
                         ▼
┌─────────────────────────────────────────────────────────────────┐
│              المستخدم ينقر على الإشعار                        │
│                                                                 │
│  نظام التشغيل يفتح التطبيق                                    │
│  _handleInitialMessage() يتم استدعاؤها                        │
│  _processNotificationData() يتم استدعاؤها                      │
└────────────────────────┬────────────────────────────────────────┘
                         │
                         ▼
┌─────────────────────────────────────────────────────────────────┐
│              فتح التطبيق                                       │
│                                                                 │
│  ✅ التطبيق يفتح                                               │
│  ✅ التنقل إلى صفحة تفاصيل الطلب                              │
│  ✅ عرض الحالة الجديدة                                        │
└─────────────────────────────────────────────────────────────────┘
```

---

## 📊 معالجات الإشعارات في FCM Service

### 1️⃣ معالج الإشعارات في المقدمة
```dart
FirebaseMessaging.onMessage.listen(_handleForegroundMessage);

// الدالة:
Future<void> _handleForegroundMessage(RemoteMessage message) async {
  // 1. استقبال الإشعار
  // 2. عرض الإشعار محلياً
  // 3. تشغيل الصوت والاهتزاز
}
```

### 2️⃣ معالج الإشعارات عند النقر (التطبيق في الخلفية)
```dart
FirebaseMessaging.onMessageOpenedApp.listen(_handleMessageOpenedApp);

// الدالة:
void _handleMessageOpenedApp(RemoteMessage message) {
  // 1. استقبال بيانات الإشعار
  // 2. معالجة البيانات
  // 3. التنقل إلى الصفحة المناسبة
}
```

### 3️⃣ معالج الإشعار الأولي (التطبيق مغلق)
```dart
Future<void> _handleInitialMessage() async {
  final initialMessage = await _messaging?.getInitialMessage();
  if (initialMessage != null) {
    // 1. استقبال بيانات الإشعار
    // 2. معالجة البيانات
    // 3. التنقل إلى الصفحة المناسبة
  }
}
```

---

## 🔔 بيانات الإشعار المستقبلة

```json
{
  "notification": {
    "title": "🚗 قيد التوصيل",
    "body": "أحمد محمد - (قيد التوصيل)"
  },
  "data": {
    "type": "order_status_update",
    "orderId": "order-123",
    "newStatus": "قيد التوصيل الى الزبون (في عهدة المندوب)",
    "customerName": "أحمد محمد",
    "timestamp": "2024-11-05T10:30:00Z",
    "click_action": "FLUTTER_NOTIFICATION_CLICK"
  }
}
```

---

## ⏱️ الأوقات المتوقعة

| الحدث | الوقت |
|--------|--------|
| تحديث الوسيط | الآن |
| المزامنة التلقائية | كل 5 دقائق |
| إرسال الإشعار | < 2 ثانية |
| وصول الإشعار للمستخدم | < 5 ثوان |
| عرض الإشعار | فوري |

---

## ✅ ما يضمنه النظام

1. ✅ **إشعار واحد فقط** - لا تكرار
2. ✅ **نص واضح** - اسم العميل + الحالة
3. ✅ **صوت وهز** - تنبيه فعال
4. ✅ **تنقل ذكي** - فتح الطلب مباشرة
5. ✅ **عمل في جميع الحالات** - مفتوح/خلفية/مغلق

